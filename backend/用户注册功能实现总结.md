# 用户注册功能实现总结

## 📋 功能概述

实现了完整的用户注册功能，当用户类型为 1（普通用户）时，自动创建对应的 User 实体并保存到数据库。

## 🏗️ 架构设计

### 核心服务层级

```
AuthController (API层)
    ↓
RegistrationService (Application层)
    ↓
UserService + UserManager (Application层)
    ↓
UserRepository (Infrastructure层)
    ↓
Database (数据库层)
```

## 🔧 实现步骤详解

### 1. 扩展用户服务接口 (`IUserService.cs`)

- 添加 `CreateUserEntityAsync` 方法：创建 User 实体
- 添加 `GetUserByApplicationUserIdAsync` 方法：根据 ApplicationUser ID 获取 User 实体

### 2. 扩展用户仓储接口 (`IUserRepository.cs`)

- 添加 `CreateAsync` 方法：创建用户实体
- 添加 `GetUserByApplicationUserIdAsync` 方法：查询关联的用户
- 添加 `SaveChangesAsync` 方法：保存数据库更改

### 3. 实现仓储层 (`UserRepository.cs`)

```csharp
public async Task<User> CreateAsync(User user)
{
    var entity = await _context.CustomUsers.AddAsync(user);
    return entity.Entity;
}

public async Task<User?> GetUserByApplicationUserIdAsync(string applicationUserId)
{
    return await _context.CustomUsers
        .Include(u => u.DefaultAddress)
        .Include(u => u.ApplicationUser)
        .FirstOrDefaultAsync(u => u.ApplicationUserId == applicationUserId);
}
```

### 4. 扩展用户服务实现 (`UserService.cs`)

```csharp
public async Task<User> CreateUserEntityAsync(ApplicationUser applicationUser, string? nickname = null)
{
    // 参数验证
    if (applicationUser.UserType != 1)
        throw new ValidationException($"UserType必须为1，当前值: {applicationUser.UserType}");

    // 检查是否已存在
    var existingUser = await _userRepository.GetUserByApplicationUserIdAsync(applicationUser.Id);
    if (existingUser != null)
        throw new BusinessException("用户实体已存在");

    // 创建User实体
    var userId = Guid.NewGuid().ToString("N");
    var userNickname = nickname ?? applicationUser.UserName ?? "用户" + userId.Substring(0, 8);
    var user = new User(userId, userNickname, applicationUser.Id);

    // 保存到数据库
    await _userRepository.CreateAsync(user);
    await _userRepository.SaveChangesAsync();

    return user;
}
```

### 5. 创建注册服务接口 (`IRegistrationService.cs`)

- 定义 `RegisterUserAsync` 方法：完整的注册流程
- 定义 `CreateBusinessEntityAsync` 方法：根据 UserType 创建对应实体
- 定义 `RegistrationResult` 类：统一的注册结果格式

### 6. 实现注册服务 (`RegistrationService.cs`)

核心注册流程：

```csharp
public async Task<RegistrationResult> RegisterUserAsync(string userName, string password, int userType,
    string? email = null, string? nickname = null)
{
    // 1. 参数验证
    // 2. 检查用户名/邮箱是否已存在
    // 3. 创建ApplicationUser
    // 4. 根据UserType创建对应的业务实体
    // 5. 返回注册结果
}
```

### 7. 扩展注册请求模型 (`UserRegisterRequest.cs`)

```csharp
public class UserRegisterRequest
{
    [Required] public required string UserName { get; set; }
    [Required] public required string PassWord { get; set; }
    [Range(1, 4)] public int UserType { get; set; }
    [EmailAddress] public string? Email { get; set; }
    [StringLength(50)] public string? Nickname { get; set; }
}
```

### 8. 修改控制器 (`AuthController.cs`)

```csharp
[HttpPost("register")]
public async Task<ActionResult<ApiResponse<object>>> Register([FromBody] UserRegisterRequest request)
{
    var result = await _registrationService.RegisterUserAsync(
        request.UserName,
        request.PassWord,
        request.UserType,
        request.Email,
        request.Nickname);

    if (result.IsSuccess)
    {
        var responseData = new
        {
            ApplicationUserId = result.ApplicationUserId,
            BusinessEntityId = result.BusinessEntityId,
            UserType = request.UserType
        };
        return Ok(ApiResponse<object>.Success(responseData, "注册成功"));
    }
    else
    {
        return BadRequest(ApiResponse<object>.Fail(ErrorCodes.ValidationFailed,
            string.Join("; ", result.Errors)));
    }
}
```

## 🔄 完整注册流程

1. **前端发送注册请求** → `POST /api/auth/register`
2. **控制器接收请求** → 调用 `RegistrationService.RegisterUserAsync`
3. **注册服务验证参数** → 检查用户名、邮箱是否已存在
4. **创建 ApplicationUser** → 使用 `UserManager.CreateAsync`
5. **根据 UserType 创建业务实体**：
   - UserType=1 → 调用 `UserService.CreateUserEntityAsync` 创建 User 实体
   - UserType=2,3,4 → 预留接口，待后续实现
6. **保存到数据库** → 通过 `UserRepository.CreateAsync`
7. **返回注册结果** → 包含 ApplicationUserId 和 BusinessEntityId

## 📊 数据关系

```
ApplicationUser (身份验证表)
    ↓ (OneToOne)
User (业务实体表 - UserType=1)
    ↓ (OneToMany)
Address, CartItem, Order, etc. (关联表)
```

## 🎯 关键设计特点

### 1. **事务一致性**

- 如果业务实体创建失败，会自动删除已创建的 ApplicationUser
- 确保数据的一致性

### 2. **参数验证**

- 多层验证：模型验证 → 服务层验证 → 仓储层验证
- 友好的错误信息返回

### 3. **扩展性**

- 预留了其他 UserType 的实现接口
- 可以轻松扩展商家、骑手、管理员的注册逻辑

### 4. **错误处理**

- 统一的异常处理机制
- 详细的日志记录
- 标准的 API 响应格式

## 🚀 API 使用示例

### 注册普通用户

```http
POST /api/auth/register
Content-Type: application/json

{
  "userName": "testuser001",
  "passWord": "Test123456",
  "userType": 1,
  "email": "test@example.com",
  "nickname": "测试用户"
}
```

### 成功响应

```json
{
  "code": 0,
  "message": "注册成功",
  "data": {
    "applicationUserId": "guid-string",
    "businessEntityId": "user-id-string",
    "userType": 1
  },
  "timestamp": 1678886400000
}
```

## 📈 后续扩展方向

1. **实现其他用户类型的注册**：

   - 商家注册（UserType=2）
   - 骑手注册（UserType=3）
   - 管理员注册（UserType=4）

2. **增强功能**：

   - 邮箱验证
   - 手机号验证
   - 验证码机制
   - 密码强度验证

3. **性能优化**：
   - 添加缓存机制
   - 数据库连接池优化
   - 异步处理优化

