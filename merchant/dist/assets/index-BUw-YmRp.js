import{at as W,d as P,au as j,av as H,a as E,c as M,o as z,w as d,f as e,q as J,N as X,B as L,g as D,_ as K,K as Y,r as A,p as re,ax as oe,s as G,ay as ae,t as Q,az as se,m as ne,aw as le,n as de,aA as ue,b as ie,h as q,aS as ce}from"./index-Cc_hmq0x.js";import{h as pe,_ as me,a as fe,b as ve,d as he}from"./table-header-operation.vue_vue_type_script_setup_true_lang-C7phqypU.js";import{u as Z,a as ye}from"./form-DOoSWg2U.js";import{a as ee,_ as Ie}from"./FormItem-CG1i80dG.js";import{_ as ge}from"./Grid-B3VkH5IZ.js";import{N as te}from"./Space-Bc6nW1Pf.js";import{N as _e}from"./Popconfirm-gTiDU7bu.js";import"./RadioGroup-itJSE8bg.js";function De(m,i){const a=new URLSearchParams;i?.startDate&&a.append("startDate",i.startDate),i?.endDate&&a.append("endDate",i.endDate),i?.size&&a.append("size",i.size.toString()),i?.page&&a.append("page",i.page.toString()),i?.orderStatus!==void 0&&a.append("orderStatus",i.orderStatus.toString());const f=a.toString(),s=`/api/merchants/${m}/orders${f?`?${f}`:""}`;return W({url:s,method:"get"})}const V={0:"未支付",1:"已支付",2:"用户确认收货",3:"已评价",4:"售后中",5:"售后结束",6:"订单关闭",7:"已派单",8:"配送中",9:"骑手已送达"};function we(m){return W({url:`/api/orders/${m}`,method:"get"})}async function be(m){try{const i=m.map(f=>we(f).then(s=>s?.data||null).catch(s=>(console.warn(`获取订单详情失败 ${f}:`,s),null)));return(await Promise.all(i)).filter(f=>f!==null)}catch(i){throw console.error("批量获取订单详情失败:",i),i}}async function ke(m,i){try{console.log("=== 开始批量获取菜品详情 ==="),console.log("商家ID:",m),console.log("菜品ID列表:",i);const a=i.map(v=>pe(m,v).then(h=>{console.log(`菜品${v}获取成功:`,h);const N=h?.data;return{dishId:v,dishData:N}}).catch(h=>(console.warn(`获取菜品详情失败 ${v}:`,h),console.warn("错误详情:",h.response?.data),{dishId:v,dishData:null}))),f=await Promise.all(a);console.log("批量获取结果:",f);const s={};return f.forEach(({dishId:v,dishData:h})=>{h&&(s[v]=h)}),console.log("最终菜品详情映射:",s),s}catch(a){return console.error("批量获取菜品详情失败:",a),{}}}function xe(m){return V[m]||"未知状态"}const Se=P({name:"OrderSearch",__name:"order-search",props:j({model:{}},{model:{required:!0},modelModifiers:{}}),emits:j(["reset","search"],["update:model"]),setup(m,{emit:i}){const a=i,{formRef:f}=Z(),s=H(m,"model"),v=E(()=>Object.entries(V).filter(([w])=>[1,2,3,4].includes(Number(w))).map(([w,I])=>({label:I,value:Number(w)})));function h(){s.value.orderId=null,s.value.orderStatus=null,a("reset")}function N(){a("search")}return(w,I)=>{const l=J,k=ve,$=X,T=L,R=te,O=ge,F=ee,U=fe,p=me,u=Y;return z(),M(u,{bordered:!1,size:"small",class:"card-wrapper"},{default:d(()=>[e(p,{"default-expanded-names":["order-search"]},{default:d(()=>[e(U,{title:"搜索",name:"order-search"},{default:d(()=>[e(F,{ref_key:"formRef",ref:f,model:s.value,"label-placement":"left","label-width":80},{default:d(()=>[e(O,{responsive:"screen","item-responsive":""},{default:d(()=>[e(k,{span:"24 s:12 m:6",label:"订单ID",path:"orderId",class:"pr-24px"},{default:d(()=>[e(l,{value:s.value.orderId,"onUpdate:value":I[0]||(I[0]=g=>s.value.orderId=g),placeholder:"请输入订单ID"},null,8,["value"])]),_:1}),e(k,{span:"24 s:12 m:6",label:"订单状态",path:"orderStatus",class:"pr-24px"},{default:d(()=>[e($,{value:s.value.orderStatus,"onUpdate:value":I[1]||(I[1]=g=>s.value.orderStatus=g),placeholder:"请选择订单状态",options:v.value,clearable:""},null,8,["value","options"])]),_:1}),e(k,{span:"24 s:12 m:6",class:"pr-24px"},{default:d(()=>[e(R,{class:"w-full",justify:"end"},{default:d(()=>[e(T,{onClick:h},{icon:d(()=>[e(K,{icon:"ic:round-refresh",class:"text-icon"})]),default:d(()=>[I[2]||(I[2]=D(" 重置 "))]),_:1,__:[2]}),e(T,{type:"primary",ghost:"",onClick:N},{icon:d(()=>[e(K,{icon:"ic:round-search",class:"text-icon"})]),default:d(()=>[I[3]||(I[3]=D(" 搜索 "))]),_:1,__:[3]})]),_:1})]),_:1})]),_:1})]),_:1},8,["model"])]),_:1})]),_:1})]),_:1})}}}),Ne=P({name:"OrderOperateDrawer",__name:"order-operate-drawer",props:j({operateType:{},rowData:{}},{visible:{type:Boolean,default:!1},visibleModifiers:{}}),emits:j(["submitted"],["update:visible"]),setup(m,{emit:i}){const a=m,f=i,s=H(m,"visible"),{formRef:v,validate:h,restoreValidation:N}=Z(),{defaultRequiredRule:w}=ye(),I=E(()=>({add:"新增订单",edit:"查看订单详情"})[a.operateType]),l=A(k());function k(){return{orderId:"",userId:"",orderAmount:0,orderStatus:1,addressId:"",couponId:"",assignid:"",reconId:""}}const $={orderId:w,userId:w,orderAmount:w},T=E(()=>Object.entries(V).map(([p,u])=>({label:u,value:Number(p)})));function R(){Object.assign(l.value,k()),a.operateType==="edit"&&a.rowData&&Object.assign(l.value,{orderId:a.rowData.orderId,userId:a.rowData.userId,orderAmount:a.rowData.orderAmount,orderStatus:a.rowData.orderStatus,addressId:a.rowData.addressId,couponId:a.rowData.couponId,assignid:a.rowData.assignid,reconId:a.rowData.reconId})}function O(){s.value=!1}async function F(){await h(),console.log("提交数据:",l.value),window.$message?.success(a.operateType==="add"?"新增成功":"更新成功"),O(),f("submitted")}const U=E(()=>a.rowData?.createAt?new Date(a.rowData.createAt).toLocaleString("zh-CN"):"");return re(s,()=>{s.value&&(R(),N())}),(p,u)=>{const g=J,x=Ie,y=ae,t=X,o=ee,n=L,S=te,b=oe,C=se;return z(),M(C,{show:s.value,"onUpdate:show":u[8]||(u[8]=c=>s.value=c),"display-directive":"show",width:420},{default:d(()=>[e(b,{title:I.value,"native-scrollbar":!1,closable:""},{footer:d(()=>[e(S,{justify:"end"},{default:d(()=>[e(n,{onClick:O},{default:d(()=>[D(Q(p.operateType==="edit"?"关闭":"取消"),1)]),_:1}),p.operateType==="add"||p.operateType==="edit"?(z(),M(n,{key:0,type:"primary",onClick:F},{default:d(()=>[D(Q(p.operateType==="edit"?"更新状态":"确定"),1)]),_:1})):G("",!0)]),_:1})]),default:d(()=>[e(o,{ref_key:"formRef",ref:v,model:l.value,rules:$},{default:d(()=>[e(x,{label:"订单ID",path:"orderId"},{default:d(()=>[e(g,{value:l.value.orderId,"onUpdate:value":u[0]||(u[0]=c=>l.value.orderId=c),placeholder:"请输入订单ID",readonly:p.operateType==="edit"},null,8,["value","readonly"])]),_:1}),e(x,{label:"用户ID",path:"userId"},{default:d(()=>[e(g,{value:l.value.userId,"onUpdate:value":u[1]||(u[1]=c=>l.value.userId=c),placeholder:"请输入用户ID",readonly:p.operateType==="edit"},null,8,["value","readonly"])]),_:1}),e(x,{label:"订单金额",path:"orderAmount"},{default:d(()=>[e(y,{value:l.value.orderAmount,"onUpdate:value":u[2]||(u[2]=c=>l.value.orderAmount=c),placeholder:"请输入订单金额",precision:2,min:0,class:"w-full",readonly:p.operateType==="edit"},{prefix:d(()=>u[9]||(u[9]=[D("¥")])),_:1},8,["value","readonly"])]),_:1}),e(x,{label:"订单状态",path:"orderStatus"},{default:d(()=>[e(t,{value:l.value.orderStatus,"onUpdate:value":u[3]||(u[3]=c=>l.value.orderStatus=c),placeholder:"请选择订单状态",options:T.value,disabled:p.operateType==="edit"},null,8,["value","options","disabled"])]),_:1}),e(x,{label:"地址信息",path:"addressId"},{default:d(()=>[e(g,{value:l.value.addressId,"onUpdate:value":u[4]||(u[4]=c=>l.value.addressId=c),placeholder:"请输入地址信息",type:"textarea",autosize:{minRows:2,maxRows:4},readonly:p.operateType==="edit"},null,8,["value","readonly"])]),_:1}),e(x,{label:"优惠券ID",path:"couponId"},{default:d(()=>[e(g,{value:l.value.couponId,"onUpdate:value":u[5]||(u[5]=c=>l.value.couponId=c),placeholder:"请输入优惠券ID",readonly:p.operateType==="edit"},null,8,["value","readonly"])]),_:1}),e(x,{label:"分配ID",path:"assignid"},{default:d(()=>[e(g,{value:l.value.assignid,"onUpdate:value":u[6]||(u[6]=c=>l.value.assignid=c),placeholder:"请输入分配ID",readonly:p.operateType==="edit"},null,8,["value","readonly"])]),_:1}),e(x,{label:"对账ID",path:"reconId"},{default:d(()=>[e(g,{value:l.value.reconId,"onUpdate:value":u[7]||(u[7]=c=>l.value.reconId=c),placeholder:"请输入对账ID",readonly:p.operateType==="edit"},null,8,["value","readonly"])]),_:1}),p.operateType==="edit"?(z(),M(x,{key:0,label:"创建时间"},{default:d(()=>[e(g,{value:U.value,readonly:""},null,8,["value"])]),_:1})):G("",!0)]),_:1},8,["model"])]),_:1},8,["title"])]),_:1},8,["show"])}}}),Ae={class:"min-h-500px flex-col-stretch gap-16px overflow-hidden lt-sm:overflow-auto"};function Ce(m){return typeof m=="function"||Object.prototype.toString.call(m)==="[object Object]"&&!ce(m)}const Be=P({name:"order-management",__name:"index",setup(m){const i=ne(),a=le(),f=A(!1),s=A([]),v=A([]),h=A([]),N=A(!1),w=A("add"),I=A(null),l=de({orderId:null,orderStatus:null}),k=async()=>{f.value=!0;try{console.log("开始获取订单数据，商家ID:",a.merchantId);const t=[0,1,2,3,4,5,6,7,8,9].map(r=>De(a.merchantId,{orderStatus:r})),o=await Promise.all(t);let n=[];if(o.forEach(r=>{const _=r?.data;Array.isArray(_)&&(n=n.concat(_))}),console.log("获取到订单ID列表:",n),n.length===0){console.log("没有找到订单数据"),v.value=[],s.value=[];return}const S=await be(n);if(console.log("获取到订单详情:",S.length,"条记录"),S.length===0){console.log("所有订单详情获取失败或无有效订单"),window.$message?.warning("未能获取到有效的订单详情信息"),v.value=[],s.value=[];return}console.log("订单详情数据样例:",S[0]);const b=S.map(r=>({orderId:r.OrderId||r.orderId||"",merchantId:r.MerchantId||r.merchantId||a.merchantId,userId:r.UserId||r.userId||"",addressId:r.AddressId||r.addressId||"",orderAmount:Number(r.OrderAmount||r.orderAmount||0),createAt:r.CreateAt||r.createAt||"",orderStatus:Number(r.OrderStatus||r.orderStatus||0),reconId:r.ReconId||r.reconId||"",couponId:r.CouponId||r.couponId||"",assignId:r.AssignId||r.assignId||"",orderDishes:Array.isArray(r.OrderDishes)?r.OrderDishes.map(_=>({dishId:_.DishId||_.dishId||"",quantity:Number(_.Quantity||_.quantity||0)})):Array.isArray(r.orderDishes)?r.orderDishes:[],orderLogIds:r.OrderLogIds||r.orderLogIds||[],paymentIds:r.PaymentIds||r.paymentIds||[],refundIds:r.RefundIds||r.refundIds||[],complaintIds:r.ComplaintIds||r.complaintIds||[],reviewIds:r.ReviewIds||r.reviewIds||[]})),C=new Set;b.forEach(r=>{r.orderDishes.forEach(_=>{_.dishId&&C.add(_.dishId)})}),console.log("订单涉及的菜品ID:",Array.from(C));let c={};if(C.size>0)try{c=await ke(a.merchantId,Array.from(C)),console.log("获取到菜品详情:",c)}catch(r){console.error("获取菜品详情失败:",r),window.$message?.warning("获取菜品详情失败，订单中菜品信息可能不完整")}const B=b.map(r=>({...r,orderDishes:r.orderDishes.map(_=>({..._,dishDetails:c[_.dishId]||null}))}));B.sort((r,_)=>new Date(_.createAt).getTime()-new Date(r.createAt).getTime()),v.value=B,s.value=B,console.log("成功获取订单详细数据（包含菜品详情）:",B.length,"条记录"),console.log("最终数据赋值给data.value:",s.value.length,"条")}catch(y){console.error("获取订单数据失败:",y);let t="获取订单数据失败";y?.response?.status===401?t="认证失败，请重新登录":y?.response?.status===403?t="权限不足，无法访问订单数据":y?.response?.status===404?t="API端点不存在，请检查后端服务状态":y?.code==="ERR_NETWORK"&&(t="网络连接失败，请检查后端服务是否运行"),window.$message?.error(t),v.value=[],s.value=[]}finally{f.value=!1}},$=()=>{let y=[...v.value];if(l.orderId&&l.orderId.trim()&&(y=y.filter(t=>t.orderId.toLowerCase().includes(l.orderId.toLowerCase()))),l.orderStatus!==null&&l.orderStatus!==void 0){const t=Number(l.orderStatus);y=y.filter(o=>Number(o.orderStatus)===t)}s.value=y},T=()=>{$()},R=()=>{Object.assign(l,{orderId:null,orderStatus:null}),s.value=[...v.value]},O=()=>{w.value="add",I.value=null,N.value=!0},F=y=>{const t=s.value.find(o=>o.orderId===y);t&&(w.value="edit",I.value=t,N.value=!0)},U=()=>{console.log("批量删除:",h.value),h.value=[],k()},p=()=>{k()},u=()=>{k()},g=A([{key:"selection",title:"选择",checked:!0},{key:"orderSummary",title:"订单概要",checked:!0},{key:"customerInfo",title:"客户信息",checked:!0},{key:"dishDetails",title:"菜品详情",checked:!0},{key:"orderAmount",title:"订单金额",checked:!0},{key:"orderStatus",title:"订单状态",checked:!0},{key:"createAt",title:"下单时间",checked:!0},{key:"dishCount",title:"菜品数量",checked:!1},{key:"paymentInfo",title:"支付信息",checked:!1},{key:"addressInfo",title:"配送地址",checked:!1},{key:"operate",title:"操作",checked:!0}]),x=E(()=>[{type:"selection",align:"center",width:48},{key:"orderSummary",title:"订单概要",align:"left",width:200,render:t=>{const o=t.orderDishes?.length||0,n=t.orderId.slice(-6),S=t.orderAmount?`¥${t.orderAmount.toFixed(2)}`:"¥0.00";return e("div",{class:"flex-col gap-4px"},[e("div",{class:"text-sm font-semibold"},[D("#"),n]),e("div",{class:"text-xs text-gray-600"},[o>0?`${o}种菜品 | ${S}`:"订单详情"])])}},{key:"customerInfo",title:"客户信息",align:"left",width:120,render:t=>{const o=t.userId?t.userId.slice(-6):"未知用户";return e("div",{class:"flex-col gap-4px"},[e("div",{class:"text-sm"},[D("用户"),o]),t.couponId&&e("div",{class:"text-xs text-blue-600"},[D("使用优惠券")])])}},{key:"dishDetails",title:"菜品详情",align:"left",width:300,render:t=>{const o=t.orderDishes||[];return o.length===0?e("div",{class:"text-sm text-gray-500"},[D("无菜品信息")]):e("div",{class:"flex-col gap-8px max-h-120px overflow-y-auto"},[o.map((n,S)=>{const b=n.dishDetails,C=b?.dishName||`菜品${n.dishId.slice(-4)}`,c=b?.price?`¥${b.price.toFixed(2)}`:"价格未知";return e("div",{key:n.dishId,class:"flex justify-between items-center text-sm border-b border-gray-100 pb-4px last:border-b-0"},[e("div",{class:"flex-col flex-1"},[e("div",{class:"font-medium text-gray-800"},[C]),e("div",{class:"text-xs text-gray-500"},[D("单价: "),c])]),e("div",{class:"text-right ml-8px"},[e("div",{class:"font-semibold text-orange-600"},[D("x"),n.quantity]),e("div",{class:"text-xs text-gray-500"},[b?.price?`¥${(b.price*n.quantity).toFixed(2)}`:"-"])])])})])}},{key:"orderAmount",title:"订单金额",align:"center",width:100,render:t=>e("div",{class:"font-semibold text-orange-600"},[D("¥"),t.orderAmount.toFixed(2)])},{key:"orderStatus",title:"订单状态",align:"center",width:100,render:t=>{const o=xe(t.orderStatus);let n="default";switch(t.orderStatus){case 0:n="error";break;case 1:n="success";break;case 2:n="info";break;case 3:n="success";break;case 4:n="warning";break;case 5:n="success";break;case 6:n="error";break;case 7:n="info";break;case 8:n="warning";break;case 9:n="info";break;default:n="default"}return e(ue,{type:n},Ce(o)?o:{default:()=>[o]})}},{key:"createAt",title:"下单时间",align:"center",width:140,render:t=>{const o=new Date(t.createAt);return e("div",{class:"flex-col gap-4px"},[e("div",{class:"text-sm"},[o.toLocaleDateString("zh-CN")]),e("div",{class:"text-xs text-gray-500"},[o.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"})])])}},{key:"dishCount",title:"菜品数量",align:"center",width:80,render:t=>{const o=t.orderDishes?.reduce((S,b)=>S+(b.quantity||0),0)||0,n=t.orderDishes?.length||0;return e("div",{class:"text-center"},[e("div",{class:"text-sm font-semibold"},[o]),e("div",{class:"text-xs text-gray-500"},[n,D("种菜品 "),o,D("份")])])}},{key:"paymentInfo",title:"支付信息",align:"center",width:120,render:t=>{const o=t.paymentIds?.length||0;return o>0?`${o}笔支付`:"无支付记录"}},{key:"addressInfo",title:"配送地址",align:"left",width:200,ellipsis:{tooltip:!0},render:t=>{const o=t.addressId?t.addressId.slice(-6):"";return o?`地址${o}`:"无地址信息"}},{key:"operate",title:"操作",align:"center",width:100,render:t=>e("div",{class:"flex-center gap-8px"},[e(L,{type:"primary",ghost:!0,size:"small",onClick:()=>F(t.orderId)},{default:()=>[D("查看详情")]})])}].filter(t=>g.value.find(n=>n.key===t.key)?.checked!==!1));return k(),(y,t)=>(z(),ie("div",Ae,[e(Se,{model:l,"onUpdate:model":t[0]||(t[0]=o=>l=o),onSearch:T,onReset:R},null,8,["model"]),e(q(Y),{title:"订单管理",bordered:!1,size:"small",class:"card-wrapper sm:flex-1-hidden"},{"header-extra":d(()=>[e(he,{columns:g.value,"onUpdate:columns":t[1]||(t[1]=o=>g.value=o),"disabled-delete":h.value.length===0,loading:f.value,onAdd:O,onDelete:U,onRefresh:p},null,8,["columns","disabled-delete","loading"])]),default:d(()=>[e(q(_e),{"checked-row-keys":h.value,"onUpdate:checkedRowKeys":t[2]||(t[2]=o=>h.value=o),columns:x.value,data:s.value,size:"small","flex-height":!q(i).isMobile,"scroll-x":1200,loading:f.value,remote:"","row-key":o=>o.orderId,class:"sm:h-full"},null,8,["checked-row-keys","columns","data","flex-height","loading","row-key"]),e(Ne,{visible:N.value,"onUpdate:visible":t[3]||(t[3]=o=>N.value=o),"operate-type":w.value,"row-data":I.value,onSubmitted:u},null,8,["visible","operate-type","row-data"])]),_:1})]))}});export{Be as default};
