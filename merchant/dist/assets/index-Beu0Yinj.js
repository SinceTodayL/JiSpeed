import{at as y,d as P,m as z,aw as T,r as h,n as C,aj as E,b as B,o as j,f as n,w as m,e as v,h as f,K as I,N as M,B as w,g,aA as F,aS as O,y as U}from"./index-CmHymj64.js";import{N as K,a as D}from"./Popconfirm-D3Sq3T5s.js";import{N as V}from"./Space-DdW0Hcsn.js";import"./RadioGroup-CnSbzXgx.js";function q(o,a){const i=new URLSearchParams;a?.size&&i.append("size",a.size.toString()),a?.page&&i.append("page",a.page.toString()),a?.auditStatus!==void 0&&i.append("auditStatus",a.auditStatus.toString());const c=i.toString(),u=`/api/merchants/${o}/refunds${c?`?${c}`:""}`;return y({url:u,method:"get"})}function L(o,a){return y({url:`/api/merchants/${o}/refunds/${a}/approve`,method:"patch",data:{}})}function J(o,a){return y({url:`/api/merchants/${o}/refunds/${a}/reject`,method:"patch"})}const k={0:"默认状态",1:"商家拒绝",2:"商家退款",3:"等待管理员处理",4:"管理员拒绝退款",5:"管理员同意退款"};function Q(o){return y({url:`/api/refunds/${o}`,method:"get"})}async function W(o){try{console.log("=== 开始批量获取退款详情 ==="),console.log("退款ID列表:",o);const a=o.map(u=>Q(u).then(d=>(console.log(`退款${u}获取成功:`,d),d?.data||null)).catch(d=>(console.warn(`获取退款详情失败 ${u}:`,d),null))),c=(await Promise.all(a)).filter(u=>u!==null);return console.log("批量获取退款详情结果:",c),c}catch(a){return console.error("批量获取退款详情失败:",a),[]}}function G(o){return k[o]||"未知状态"}const H={class:"min-h-500px flex-col-stretch gap-16px overflow-hidden <sm:overflow-auto"},X={class:"mb-4"},Y={class:"flex items-center gap-4"};function Z(o){return typeof o=="function"||Object.prototype.toString.call(o)==="[object Object]"&&!O(o)}const ee=P({name:"refund-management",__name:"index",setup(o){z();const a=T(),i=h([]),c=h(!1),u=h([]),d=C({auditStatus:0}),S=h([]),A=[{label:"全部",value:null},{label:"待处理",value:0},{label:"商家拒绝",value:1},{label:"商家退款",value:2},{label:"等待管理员处理",value:3},{label:"管理员拒绝",value:4},{label:"管理员同意",value:5}],p=async()=>{c.value=!0;try{if(console.log("开始获取退款申请数据，商家ID:",a.merchantId),!a.merchantId){console.warn("商家ID为空，无法获取退款数据"),c.value=!1;return}const s=await q(a.merchantId,{auditStatus:d.auditStatus||void 0});console.log("获取到退款申请ID列表:",s);const t=s?.data;if(Array.isArray(t)&&t.length>0){console.log("获取到退款申请ID:",t.length,"个");const e=await W(t);if(console.log("获取到退款详情:",e.length,"条记录"),e.length>0){console.log("=== 退款数据状态分析 ==="),e.forEach((r,N)=>{console.log(`退款${N+1}:`,{refundId:r.refundId,auditStatus:r.auditStatus,statusText:k[r.auditStatus]||"未知状态",canOperate:r.auditStatus===0?"✅ 可操作":"❌ 不可操作"})});const l=e.filter(r=>r.auditStatus===0).length;console.log(`总计 ${e.length} 条退款，其中 ${l} 条可操作`),u.value=e,i.value=[...e],l===0&&d.auditStatus===0&&window.$message?.info("当前没有待处理的退款申请")}else console.log("所有退款详情获取失败或无有效退款"),window.$message?.warning("未能获取到有效的退款详情信息"),u.value=[],i.value=[]}else console.log("没有找到退款申请数据"),u.value=[],i.value=[]}catch(s){console.error("获取退款申请数据失败:",s);let t="获取退款数据失败，请稍后重试";const e=s;e?.response?.status===401?t="认证失败，请重新登录":e?.response?.status===403?t="权限不足，无法访问退款数据":e?.response?.status===404?t="API端点不存在，请检查后端服务状态":e?.code==="ERR_NETWORK"&&(t="网络连接失败，请检查后端服务是否运行"),window.$message?.error(t),u.value=[],i.value=[]}finally{c.value=!1}},$=async s=>{if(!a.merchantId){window.$message?.error("商家信息未找到，无法操作");return}try{console.log("=== 商家同意退款申请 ==="),console.log("商家ID:",a.merchantId),console.log("退款ID:",s);const t=await L(a.merchantId,s);console.log("同意退款API响应:",t);const e=t;let l=!1,r="";e?.data===!0||e?.code===0?(l=!0,r=e?.message||"退款申请已同意"):e===!0&&(l=!0,r="退款申请已同意"),l?(window.$message?.success(r),console.log("同意退款成功，开始刷新数据"),await p()):(console.warn("同意退款失败，API返回:",t),window.$message?.error(r||"同意退款失败"))}catch(t){console.error("同意退款API调用失败:",t);const e=t,l=e?.response?.data?.message||e?.message||"同意退款失败，请重试";window.$message?.error(l)}},x=async s=>{if(!a.merchantId){window.$message?.error("商家信息未找到，无法操作");return}try{console.log("=== 商家拒绝退款申请 ==="),console.log("商家ID:",a.merchantId),console.log("退款ID:",s);const t=await J(a.merchantId,s);console.log("拒绝退款API响应:",t);const e=t;let l=!1,r="";e?.data===!0||e?.code===0?(l=!0,r=e?.message||"退款申请已拒绝"):e===!0&&(l=!0,r="退款申请已拒绝"),l?(window.$message?.success(r),console.log("拒绝退款成功，开始刷新数据"),await p()):(console.warn("拒绝退款失败，API返回:",t),window.$message?.error(r||"拒绝退款失败"))}catch(t){console.error("拒绝退款API调用失败:",t);const e=t,l=e?.response?.data?.message||e?.message||"拒绝退款失败，请重试";window.$message?.error(l)}},b=()=>{p()},_=()=>{d.auditStatus=0,p()},R=[{type:"selection",disabled(s){return s.auditStatus!==1}},{key:"index",title:"序号",width:60,render:(s,t)=>t+1},{key:"refundId",title:"退款申请ID",width:200,ellipsis:{tooltip:!0}},{key:"orderId",title:"关联订单ID",width:200,ellipsis:{tooltip:!0}},{key:"refundAmount",title:"退款金额",width:120,render:s=>n("span",{class:"text-green-600 font-semibold"},[g("¥"),(s.refundAmount/100).toFixed(2)])},{key:"reason",title:"退款理由",width:200,ellipsis:{tooltip:!0},render:s=>n("span",null,[s.reason||"无"])},{key:"auditStatus",title:"审核状态",width:100,render:s=>{const t=G(s.auditStatus);let e="default";switch(s.auditStatus){case 0:e="warning";break;case 1:e="error";break;case 2:e="success";break;case 3:e="info";break;case 4:e="error";break;case 5:e="success";break;default:e="default"}return n(F,{type:e},Z(t)?t:{default:()=>[t]})}},{key:"applyAt",title:"申请时间",width:180,render:s=>n("span",null,[new Date(s.applyAt).toLocaleString("zh-CN")])},{key:"finishAt",title:"处理时间",width:180,render:s=>n("span",null,[s.finishAt?new Date(s.finishAt).toLocaleString("zh-CN"):"未处理"])},{key:"operate",title:"操作",width:200,render:s=>(console.log(`渲染操作列 - 退款ID: ${s.refundId}, 状态: ${s.auditStatus}, 可操作: ${s.auditStatus===0}`),s.auditStatus!==0?n("span",{class:"text-gray-400"},[g("已处理")]):n(V,{size:8},{default:()=>[n(D,{onPositiveClick:()=>$(s.refundId),positiveText:"确认同意",negativeText:"取消"},{default:()=>"确认同意此退款申请？",trigger:()=>n(w,{size:"small",type:"success",ghost:!0},{default:()=>[g("同意退款")]})}),n(D,{onPositiveClick:()=>x(s.refundId),positiveText:"确认拒绝",negativeText:"取消"},{default:()=>"确认拒绝此退款申请？",trigger:()=>n(w,{size:"small",type:"error",ghost:!0},{default:()=>[g("拒绝退款")]})})]}))}];return E(()=>{p()}),(s,t)=>(j(),B("div",H,[n(f(I),{title:"退款管理",bordered:!1,size:"small",class:"sm:flex-1-hidden card-wrapper"},{default:m(()=>[v("div",X,[n(f(I),{bordered:!1,size:"small"},{default:m(()=>[v("div",Y,[n(f(M),{value:d.auditStatus,"onUpdate:value":t[0]||(t[0]=e=>d.auditStatus=e),options:A,placeholder:"审核状态",clearable:"",class:"w-200px"},null,8,["value"]),n(f(w),{type:"primary",onClick:b},{default:m(()=>t[2]||(t[2]=[g(" 搜索 ")])),_:1,__:[2]}),n(f(w),{onClick:_},{default:m(()=>t[3]||(t[3]=[g(" 重置 ")])),_:1,__:[3]})])]),_:1})]),n(f(K),{"checked-row-keys":S.value,"onUpdate:checkedRowKeys":t[1]||(t[1]=e=>S.value=e),columns:R,data:i.value,size:"small",loading:c.value,"row-key":e=>e.refundId,pagination:{pageSize:20,showSizePicker:!0,showQuickJumper:!0,pageSizes:[10,20,50,100]},"single-line":!1,class:"sm:h-320px"},null,8,["checked-row-keys","data","loading","row-key"])]),_:1})]))}}),ne=U(ee,[["__scopeId","data-v-e2524d18"]]);export{ne as default};
