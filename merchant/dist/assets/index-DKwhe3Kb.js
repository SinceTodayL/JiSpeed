import{at as W,d as L,au as q,av as H,a as U,c as j,o as B,w as d,f as e,q as J,N as X,B as C,g as m,_ as K,K as Y,r as N,p as re,ax as ae,s as G,ay as oe,t as Q,az as se,m as ne,aw as le,n as de,aA as ue,b as ie,h as P,aS as ce}from"./index-D4jBhmpn.js";import{h as pe,_ as me,a as fe,b as ve,d as he}from"./table-header-operation.vue_vue_type_script_setup_true_lang-ByZ9GMTU.js";import{u as Z,a as ye}from"./form-C88og8_N.js";import{a as ee,_ as ge}from"./FormItem-D6oeNKH1.js";import{_ as Ie}from"./Grid-BNRmkpl5.js";import{N as te}from"./Space-DO3KNHCj.js";import{N as De}from"./Popconfirm-fYaefAKK.js";import"./RadioGroup-TRbPB1DA.js";function _e(f,i){const o=new URLSearchParams;i?.startDate&&o.append("startDate",i.startDate),i?.endDate&&o.append("endDate",i.endDate),i?.size&&o.append("size",i.size.toString()),i?.page&&o.append("page",i.page.toString()),i?.orderStatus!==void 0&&o.append("orderStatus",i.orderStatus.toString());const v=o.toString(),s=`/api/merchants/${f}/orders${v?`?${v}`:""}`;return W({url:s,method:"get"})}const V={0:"未支付",1:"已支付",2:"用户确认收货",3:"已评价",4:"售后中",5:"售后结束",6:"订单关闭",7:"已派单",8:"配送中",9:"骑手已送达"};function be(f){return W({url:`/api/orders/${f}`,method:"get"})}async function we(f){try{const i=f.map(v=>be(v).then(s=>s?.data||null).catch(s=>(console.warn(`获取订单详情失败 ${v}:`,s),null)));return(await Promise.all(i)).filter(v=>v!==null)}catch(i){throw console.error("批量获取订单详情失败:",i),i}}async function Se(f,i){try{console.log("=== 开始批量获取菜品详情 ==="),console.log("商家ID:",f),console.log("菜品ID列表:",i);const o=i.map(h=>pe(f,h).then(y=>{console.log(`菜品${h}获取成功:`,y);const A=y?.data;return{dishId:h,dishData:A}}).catch(y=>(console.warn(`获取菜品详情失败 ${h}:`,y),console.warn("错误详情:",y.response?.data),{dishId:h,dishData:null}))),v=await Promise.all(o);console.log("批量获取结果:",v);const s={};return v.forEach(({dishId:h,dishData:y})=>{y&&(s[h]=y)}),console.log("最终菜品详情映射:",s),s}catch(o){return console.error("批量获取菜品详情失败:",o),{}}}function ke(f){return V[f]||"未知状态"}const xe=L({name:"OrderSearch",__name:"order-search",props:q({model:{}},{model:{required:!0},modelModifiers:{}}),emits:q(["reset","search"],["update:model"]),setup(f,{emit:i}){const o=i,{formRef:v}=Z(),s=H(f,"model"),h=U(()=>Object.entries(V).filter(([b])=>[1,2,3,4].includes(Number(b))).map(([b,I])=>({label:I,value:Number(b)})));function y(){s.value.orderId=null,s.value.orderStatus=null,o("reset")}function A(){o("search")}return(b,I)=>{const l=J,S=ve,E=X,O=C,R=te,$=Ie,F=ee,z=fe,p=me,u=Y;return B(),j(u,{bordered:!1,size:"small",class:"card-wrapper"},{default:d(()=>[e(p,{"default-expanded-names":["order-search"]},{default:d(()=>[e(z,{title:"搜索",name:"order-search"},{default:d(()=>[e(F,{ref_key:"formRef",ref:v,model:s.value,"label-placement":"left","label-width":80},{default:d(()=>[e($,{responsive:"screen","item-responsive":""},{default:d(()=>[e(S,{span:"24 s:12 m:6",label:"订单ID",path:"orderId",class:"pr-24px"},{default:d(()=>[e(l,{value:s.value.orderId,"onUpdate:value":I[0]||(I[0]=D=>s.value.orderId=D),placeholder:"请输入订单ID"},null,8,["value"])]),_:1}),e(S,{span:"24 s:12 m:6",label:"订单状态",path:"orderStatus",class:"pr-24px"},{default:d(()=>[e(E,{value:s.value.orderStatus,"onUpdate:value":I[1]||(I[1]=D=>s.value.orderStatus=D),placeholder:"请选择订单状态",options:h.value,clearable:""},null,8,["value","options"])]),_:1}),e(S,{span:"24 s:12 m:6",class:"pr-24px"},{default:d(()=>[e(R,{class:"w-full",justify:"end"},{default:d(()=>[e(O,{onClick:y},{icon:d(()=>[e(K,{icon:"ic:round-refresh",class:"text-icon"})]),default:d(()=>[I[2]||(I[2]=m(" 重置 "))]),_:1,__:[2]}),e(O,{type:"primary",ghost:"",onClick:A},{icon:d(()=>[e(K,{icon:"ic:round-search",class:"text-icon"})]),default:d(()=>[I[3]||(I[3]=m(" 搜索 "))]),_:1,__:[3]})]),_:1})]),_:1})]),_:1})]),_:1},8,["model"])]),_:1})]),_:1})]),_:1})}}}),Ae=L({name:"OrderOperateDrawer",__name:"order-operate-drawer",props:q({operateType:{},rowData:{}},{visible:{type:Boolean,default:!1},visibleModifiers:{}}),emits:q(["submitted"],["update:visible"]),setup(f,{emit:i}){const o=f,v=i,s=H(f,"visible"),{formRef:h,validate:y,restoreValidation:A}=Z(),{defaultRequiredRule:b}=ye(),I=U(()=>({add:"新增订单",edit:"查看订单详情"})[o.operateType]),l=N(S());function S(){return{orderId:"",userId:"",orderAmount:0,orderStatus:1,addressId:"",couponId:"",assignid:"",reconId:""}}const E={orderId:b,userId:b,orderAmount:b},O=U(()=>Object.entries(V).map(([p,u])=>({label:u,value:Number(p)})));function R(){Object.assign(l.value,S()),o.operateType==="edit"&&o.rowData&&Object.assign(l.value,{orderId:o.rowData.orderId,userId:o.rowData.userId,orderAmount:o.rowData.orderAmount,orderStatus:o.rowData.orderStatus,addressId:o.rowData.addressId,couponId:o.rowData.couponId,assignid:o.rowData.assignid,reconId:o.rowData.reconId})}function $(){s.value=!1}async function F(){await y(),console.log("提交数据:",l.value),window.$message?.success(o.operateType==="add"?"新增成功":"更新成功"),$(),v("submitted")}const z=U(()=>o.rowData?.createAt?new Date(o.rowData.createAt).toLocaleString("zh-CN"):"");return re(s,()=>{s.value&&(R(),A())}),(p,u)=>{const D=J,k=ge,g=oe,t=X,a=ee,n=C,x=te,w=ae,T=se;return B(),j(T,{show:s.value,"onUpdate:show":u[8]||(u[8]=c=>s.value=c),"display-directive":"show",width:420},{default:d(()=>[e(w,{title:I.value,"native-scrollbar":!1,closable:""},{footer:d(()=>[e(x,{justify:"end"},{default:d(()=>[e(n,{onClick:$},{default:d(()=>[m(Q(p.operateType==="edit"?"关闭":"取消"),1)]),_:1}),p.operateType==="add"||p.operateType==="edit"?(B(),j(n,{key:0,type:"primary",onClick:F},{default:d(()=>[m(Q(p.operateType==="edit"?"更新状态":"确定"),1)]),_:1})):G("",!0)]),_:1})]),default:d(()=>[e(a,{ref_key:"formRef",ref:h,model:l.value,rules:E},{default:d(()=>[e(k,{label:"订单ID",path:"orderId"},{default:d(()=>[e(D,{value:l.value.orderId,"onUpdate:value":u[0]||(u[0]=c=>l.value.orderId=c),placeholder:"请输入订单ID",readonly:p.operateType==="edit"},null,8,["value","readonly"])]),_:1}),e(k,{label:"用户ID",path:"userId"},{default:d(()=>[e(D,{value:l.value.userId,"onUpdate:value":u[1]||(u[1]=c=>l.value.userId=c),placeholder:"请输入用户ID",readonly:p.operateType==="edit"},null,8,["value","readonly"])]),_:1}),e(k,{label:"订单金额",path:"orderAmount"},{default:d(()=>[e(g,{value:l.value.orderAmount,"onUpdate:value":u[2]||(u[2]=c=>l.value.orderAmount=c),placeholder:"请输入订单金额",precision:2,min:0,class:"w-full",readonly:p.operateType==="edit"},{prefix:d(()=>u[9]||(u[9]=[m("¥")])),_:1},8,["value","readonly"])]),_:1}),e(k,{label:"订单状态",path:"orderStatus"},{default:d(()=>[e(t,{value:l.value.orderStatus,"onUpdate:value":u[3]||(u[3]=c=>l.value.orderStatus=c),placeholder:"请选择订单状态",options:O.value,disabled:p.operateType==="edit"},null,8,["value","options","disabled"])]),_:1}),e(k,{label:"地址信息",path:"addressId"},{default:d(()=>[e(D,{value:l.value.addressId,"onUpdate:value":u[4]||(u[4]=c=>l.value.addressId=c),placeholder:"请输入地址信息",type:"textarea",autosize:{minRows:2,maxRows:4},readonly:p.operateType==="edit"},null,8,["value","readonly"])]),_:1}),e(k,{label:"优惠券ID",path:"couponId"},{default:d(()=>[e(D,{value:l.value.couponId,"onUpdate:value":u[5]||(u[5]=c=>l.value.couponId=c),placeholder:"请输入优惠券ID",readonly:p.operateType==="edit"},null,8,["value","readonly"])]),_:1}),e(k,{label:"分配ID",path:"assignid"},{default:d(()=>[e(D,{value:l.value.assignid,"onUpdate:value":u[6]||(u[6]=c=>l.value.assignid=c),placeholder:"请输入分配ID",readonly:p.operateType==="edit"},null,8,["value","readonly"])]),_:1}),e(k,{label:"对账ID",path:"reconId"},{default:d(()=>[e(D,{value:l.value.reconId,"onUpdate:value":u[7]||(u[7]=c=>l.value.reconId=c),placeholder:"请输入对账ID",readonly:p.operateType==="edit"},null,8,["value","readonly"])]),_:1}),p.operateType==="edit"?(B(),j(k,{key:0,label:"创建时间"},{default:d(()=>[e(D,{value:z.value,readonly:""},null,8,["value"])]),_:1})):G("",!0)]),_:1},8,["model"])]),_:1},8,["title"])]),_:1},8,["show"])}}}),Ne={class:"min-h-500px flex-col-stretch gap-16px overflow-hidden lt-sm:overflow-auto"};function Ce(f){return typeof f=="function"||Object.prototype.toString.call(f)==="[object Object]"&&!ce(f)}const Be=L({name:"order-management",__name:"index",setup(f){const i=ne(),o=le(),v=N(!1),s=N([]),h=N([]),y=N([]),A=N(!1),b=N("add"),I=N(null),l=de({orderId:null,orderStatus:null}),S=async()=>{v.value=!0;try{console.log("开始获取订单数据，商家ID:",o.merchantId);const t=[0,1,2,3,4,5,6,7,8,9].map(r=>_e(o.merchantId,{orderStatus:r})),a=await Promise.all(t);let n=[];if(a.forEach(r=>{const _=r?.data;Array.isArray(_)&&(n=n.concat(_))}),console.log("获取到订单ID列表:",n),n.length===0){console.log("没有找到订单数据"),h.value=[],s.value=[];return}const x=await we(n);if(console.log("获取到订单详情:",x.length,"条记录"),x.length===0){console.log("所有订单详情获取失败或无有效订单"),window.$message?.warning("未能获取到有效的订单详情信息"),h.value=[],s.value=[];return}console.log("订单详情数据样例:",x[0]);const w=x.map(r=>({orderId:r.OrderId||r.orderId||"",merchantId:r.MerchantId||r.merchantId||o.merchantId,userId:r.UserId||r.userId||"",addressId:r.AddressId||r.addressId||"",orderAmount:Number(r.OrderAmount||r.orderAmount||0),createAt:r.CreateAt||r.createAt||"",orderStatus:Number(r.OrderStatus||r.orderStatus||0),reconId:r.ReconId||r.reconId||"",couponId:r.CouponId||r.couponId||"",assignId:r.AssignId||r.assignId||"",orderDishes:Array.isArray(r.OrderDishes)?r.OrderDishes.map(_=>({dishId:_.DishId||_.dishId||"",quantity:Number(_.Quantity||_.quantity||0)})):Array.isArray(r.orderDishes)?r.orderDishes:[],orderLogIds:r.OrderLogIds||r.orderLogIds||[],paymentIds:r.PaymentIds||r.paymentIds||[],refundIds:r.RefundIds||r.refundIds||[],complaintIds:r.ComplaintIds||r.complaintIds||[],reviewIds:r.ReviewIds||r.reviewIds||[]})),T=new Set;w.forEach(r=>{r.orderDishes.forEach(_=>{_.dishId&&T.add(_.dishId)})}),console.log("订单涉及的菜品ID:",Array.from(T));let c={};if(T.size>0)try{c=await Se(o.merchantId,Array.from(T)),console.log("获取到菜品详情:",c)}catch(r){console.error("获取菜品详情失败:",r),window.$message?.warning("获取菜品详情失败，订单中菜品信息可能不完整")}const M=w.map(r=>({...r,orderDishes:r.orderDishes.map(_=>({..._,dishDetails:c[_.dishId]||null}))}));M.sort((r,_)=>new Date(_.createAt).getTime()-new Date(r.createAt).getTime()),h.value=M,s.value=M,console.log("成功获取订单详细数据（包含菜品详情）:",M.length,"条记录"),console.log("最终数据赋值给data.value:",s.value.length,"条")}catch(g){console.error("获取订单数据失败:",g);let t="获取订单数据失败";g?.response?.status===401?t="认证失败，请重新登录":g?.response?.status===403?t="权限不足，无法访问订单数据":g?.response?.status===404?t="API端点不存在，请检查后端服务状态":g?.code==="ERR_NETWORK"&&(t="网络连接失败，请检查后端服务是否运行"),window.$message?.error(t),h.value=[],s.value=[]}finally{v.value=!1}},E=()=>{let g=[...h.value];if(l.orderId&&l.orderId.trim()&&(g=g.filter(t=>t.orderId.toLowerCase().includes(l.orderId.toLowerCase()))),l.orderStatus!==null&&l.orderStatus!==void 0){const t=Number(l.orderStatus);g=g.filter(a=>Number(a.orderStatus)===t)}s.value=g},O=()=>{E()},R=()=>{Object.assign(l,{orderId:null,orderStatus:null}),s.value=[...h.value]},$=()=>{b.value="add",I.value=null,A.value=!0},F=g=>{const t=s.value.find(a=>a.orderId===g);t&&(b.value="edit",I.value=t,A.value=!0)},z=()=>{console.log("批量删除:",y.value),y.value=[],S()},p=()=>{S()},u=()=>{S()},D=N([{key:"selection",title:"选择",checked:!0},{key:"orderSummary",title:"订单概要",checked:!0},{key:"customerInfo",title:"客户信息",checked:!0},{key:"dishDetails",title:"菜品详情",checked:!0},{key:"orderAmount",title:"订单金额",checked:!0},{key:"orderStatus",title:"订单状态",checked:!0},{key:"createAt",title:"下单时间",checked:!0},{key:"dishCount",title:"菜品数量",checked:!1},{key:"paymentInfo",title:"支付信息",checked:!1},{key:"addressInfo",title:"配送地址",checked:!1},{key:"operate",title:"操作",checked:!0}]),k=U(()=>[{type:"selection",align:"center",width:48},{key:"orderSummary",title:"订单概要",align:"left",width:200,render:t=>{const a=t.orderDishes?.length||0,n=t.orderId.slice(-6),x=t.orderAmount?`¥${t.orderAmount.toFixed(2)}`:"¥0.00";return e("div",{class:"flex-col gap-4px"},[e("div",{class:"text-sm font-semibold"},[m("#"),n]),e("div",{class:"text-xs text-gray-600"},[a>0?`${a}种菜品 | ${x}`:"订单详情"])])}},{key:"customerInfo",title:"客户信息",align:"left",width:120,render:t=>{const a=t.userId?t.userId.slice(-6):"未知用户";return e("div",{class:"flex-col gap-4px"},[e("div",{class:"text-sm"},[m("用户"),a]),t.couponId&&e("div",{class:"text-xs text-blue-600"},[m("使用优惠券")])])}},{key:"dishDetails",title:"菜品详情",align:"left",width:300,render:t=>{const a=t.orderDishes||[];return a.length===0?e("div",{class:"text-sm text-gray-500"},[m("无菜品信息")]):e("div",{class:"flex-col gap-8px max-h-120px overflow-y-auto"},[a.map((n,x)=>{const w=n.dishDetails,T=w?.dishName||`菜品${n.dishId.slice(-4)}`,c=w?.price?`¥${w.price.toFixed(2)}`:"价格未知";return e("div",{key:n.dishId,class:"flex justify-between items-center text-sm border-b border-gray-100 pb-4px last:border-b-0"},[e("div",{class:"flex-col flex-1"},[e("div",{class:"font-medium text-gray-800"},[T]),e("div",{class:"text-xs text-gray-500"},[m("单价: "),c])]),e("div",{class:"text-right ml-8px"},[e("div",{class:"font-semibold text-orange-600"},[m("x"),n.quantity]),e("div",{class:"text-xs text-gray-500"},[w?.price?`¥${(w.price*n.quantity).toFixed(2)}`:"-"])])])})])}},{key:"orderAmount",title:"订单金额",align:"center",width:100,render:t=>e("div",{class:"font-semibold text-orange-600"},[m("¥"),t.orderAmount.toFixed(2)])},{key:"orderStatus",title:"订单状态",align:"center",width:100,render:t=>{const a=ke(t.orderStatus);let n="default";switch(t.orderStatus){case 0:n="error";break;case 1:n="success";break;case 2:n="info";break;case 3:n="success";break;case 4:n="warning";break;case 5:n="success";break;case 6:n="error";break;case 7:n="info";break;case 8:n="warning";break;case 9:n="info";break;default:n="default"}return e(ue,{type:n},Ce(a)?a:{default:()=>[a]})}},{key:"createAt",title:"下单时间",align:"center",width:140,render:t=>{const a=new Date(t.createAt);return e("div",{class:"flex-col gap-4px"},[e("div",{class:"text-sm"},[a.toLocaleDateString("zh-CN")]),e("div",{class:"text-xs text-gray-500"},[a.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"})])])}},{key:"dishCount",title:"菜品数量",align:"center",width:80,render:t=>{const a=t.orderDishes?.reduce((x,w)=>x+(w.quantity||0),0)||0,n=t.orderDishes?.length||0;return e("div",{class:"text-center"},[e("div",{class:"text-sm font-semibold"},[a]),e("div",{class:"text-xs text-gray-500"},[n,m("种菜品 "),a,m("份")])])}},{key:"paymentInfo",title:"支付信息",align:"center",width:120,render:t=>{const a=t.paymentIds?.length||0;return a>0?`${a}笔支付`:"无支付记录"}},{key:"addressInfo",title:"配送地址",align:"left",width:200,ellipsis:{tooltip:!0},render:t=>{const a=t.addressId?t.addressId.slice(-6):"";return a?`地址${a}`:"无地址信息"}},{key:"operate",title:"操作",align:"center",width:160,render:t=>e("div",{class:"flex-center gap-8px"},[e(C,{type:"primary",ghost:!0,size:"small",onClick:()=>F(t.orderId)},{default:()=>[m("查看详情")]}),t.orderStatus===0&&e(C,{type:"error",ghost:!0,size:"small"},{default:()=>[m("提醒支付")]}),t.orderStatus===1&&e(C,{type:"success",ghost:!0,size:"small"},{default:()=>[m("确认订单")]}),t.orderStatus===4&&e(C,{type:"warning",ghost:!0,size:"small"},{default:()=>[m("处理售后")]}),t.orderStatus===7&&e(C,{type:"info",ghost:!0,size:"small"},{default:()=>[m("安排配送")]}),t.orderStatus===8&&e(C,{type:"warning",ghost:!0,size:"small"},{default:()=>[m("配送跟踪")]}),t.orderStatus===9&&e(C,{type:"info",ghost:!0,size:"small"},{default:()=>[m("确认完成")]})])}].filter(t=>D.value.find(n=>n.key===t.key)?.checked!==!1));return S(),(g,t)=>(B(),ie("div",Ne,[e(xe,{model:l,"onUpdate:model":t[0]||(t[0]=a=>l=a),onSearch:O,onReset:R},null,8,["model"]),e(P(Y),{title:"订单管理",bordered:!1,size:"small",class:"card-wrapper sm:flex-1-hidden"},{"header-extra":d(()=>[e(he,{columns:D.value,"onUpdate:columns":t[1]||(t[1]=a=>D.value=a),"disabled-delete":y.value.length===0,loading:v.value,onAdd:$,onDelete:z,onRefresh:p},null,8,["columns","disabled-delete","loading"])]),default:d(()=>[e(P(De),{"checked-row-keys":y.value,"onUpdate:checkedRowKeys":t[2]||(t[2]=a=>y.value=a),columns:k.value,data:s.value,size:"small","flex-height":!P(i).isMobile,"scroll-x":1200,loading:v.value,remote:"","row-key":a=>a.orderId,class:"sm:h-full"},null,8,["checked-row-keys","columns","data","flex-height","loading","row-key"]),e(Ae,{visible:A.value,"onUpdate:visible":t[3]||(t[3]=a=>A.value=a),"operate-type":b.value,"row-data":I.value,onSubmitted:u},null,8,["visible","operate-type","row-data"])]),_:1})]))}});export{Be as default};
