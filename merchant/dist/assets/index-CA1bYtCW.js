import{at as W,d as L,au as q,av as H,a as B,c as j,o as z,w as l,f as e,q as J,N as X,B as T,g as v,_ as K,K as Y,r as N,p as re,ax as oe,s as G,ay as ae,t as Q,az as se,m as ne,aw as le,n as de,aA as ue,b as ie,h as P,aS as ce}from"./index-474AxnhT.js";import{h as pe,_ as me,a as fe,b as ve,d as he}from"./table-header-operation.vue_vue_type_script_setup_true_lang-CPfnU0DS.js";import{u as Z,a as ye}from"./form-CRz9X7mI.js";import{a as ee,_ as ge}from"./FormItem-CadS3l4o.js";import{_ as Ie}from"./Grid-BOPiN3iW.js";import{N as te}from"./Space-C82Gq11v.js";import{N as _e}from"./Popconfirm-Ddp2clPN.js";import"./RadioGroup-DMZrekBm.js";function De(m,i){const a=new URLSearchParams;i?.startDate&&a.append("startDate",i.startDate),i?.endDate&&a.append("endDate",i.endDate),i?.size&&a.append("size",i.size.toString()),i?.page&&a.append("page",i.page.toString()),i?.orderStatus!==void 0&&a.append("orderStatus",i.orderStatus.toString());const f=a.toString(),s=`/api/merchants/${m}/orders${f?`?${f}`:""}`;return W({url:s,method:"get"})}const V={0:"未支付",1:"已支付",2:"确认收货",3:"已评价",4:"售后中",5:"售后结束",6:"订单关闭",7:"配送中",8:"待配送"};function we(m){return W({url:`/api/orders/${m}`,method:"get"})}async function be(m){try{const i=m.map(f=>we(f).then(s=>s?.data||null).catch(s=>(console.warn(`获取订单详情失败 ${f}:`,s),null)));return(await Promise.all(i)).filter(f=>f!==null)}catch(i){throw console.error("批量获取订单详情失败:",i),i}}async function Se(m,i){try{console.log("=== 开始批量获取菜品详情 ==="),console.log("商家ID:",m),console.log("菜品ID列表:",i);const a=i.map(h=>pe(m,h).then(y=>{console.log(`菜品${h}获取成功:`,y);const A=y?.data;return{dishId:h,dishData:A}}).catch(y=>(console.warn(`获取菜品详情失败 ${h}:`,y),console.warn("错误详情:",y.response?.data),{dishId:h,dishData:null}))),f=await Promise.all(a);console.log("批量获取结果:",f);const s={};return f.forEach(({dishId:h,dishData:y})=>{y&&(s[h]=y)}),console.log("最终菜品详情映射:",s),s}catch(a){return console.error("批量获取菜品详情失败:",a),{}}}function xe(m){return V[m]||"未知状态"}const ke=L({name:"OrderSearch",__name:"order-search",props:q({model:{}},{model:{required:!0},modelModifiers:{}}),emits:q(["reset","search"],["update:model"]),setup(m,{emit:i}){const a=i,{formRef:f}=Z(),s=H(m,"model"),h=B(()=>Object.entries(V).filter(([w])=>[1,2,3,4].includes(Number(w))).map(([w,I])=>({label:I,value:Number(w)})));function y(){s.value.orderId=null,s.value.orderStatus=null,a("reset")}function A(){a("search")}return(w,I)=>{const n=J,S=ve,R=X,O=T,E=te,$=Ie,F=ee,U=fe,p=me,u=Y;return z(),j(u,{bordered:!1,size:"small",class:"card-wrapper"},{default:l(()=>[e(p,{"default-expanded-names":["order-search"]},{default:l(()=>[e(U,{title:"搜索",name:"order-search"},{default:l(()=>[e(F,{ref_key:"formRef",ref:f,model:s.value,"label-placement":"left","label-width":80},{default:l(()=>[e($,{responsive:"screen","item-responsive":""},{default:l(()=>[e(S,{span:"24 s:12 m:6",label:"订单ID",path:"orderId",class:"pr-24px"},{default:l(()=>[e(n,{value:s.value.orderId,"onUpdate:value":I[0]||(I[0]=_=>s.value.orderId=_),placeholder:"请输入订单ID"},null,8,["value"])]),_:1}),e(S,{span:"24 s:12 m:6",label:"订单状态",path:"orderStatus",class:"pr-24px"},{default:l(()=>[e(R,{value:s.value.orderStatus,"onUpdate:value":I[1]||(I[1]=_=>s.value.orderStatus=_),placeholder:"请选择订单状态",options:h.value,clearable:""},null,8,["value","options"])]),_:1}),e(S,{span:"24 s:12 m:6",class:"pr-24px"},{default:l(()=>[e(E,{class:"w-full",justify:"end"},{default:l(()=>[e(O,{onClick:y},{icon:l(()=>[e(K,{icon:"ic:round-refresh",class:"text-icon"})]),default:l(()=>[I[2]||(I[2]=v(" 重置 "))]),_:1,__:[2]}),e(O,{type:"primary",ghost:"",onClick:A},{icon:l(()=>[e(K,{icon:"ic:round-search",class:"text-icon"})]),default:l(()=>[I[3]||(I[3]=v(" 搜索 "))]),_:1,__:[3]})]),_:1})]),_:1})]),_:1})]),_:1},8,["model"])]),_:1})]),_:1})]),_:1})}}}),Ae=L({name:"OrderOperateDrawer",__name:"order-operate-drawer",props:q({operateType:{},rowData:{}},{visible:{type:Boolean,default:!1},visibleModifiers:{}}),emits:q(["submitted"],["update:visible"]),setup(m,{emit:i}){const a=m,f=i,s=H(m,"visible"),{formRef:h,validate:y,restoreValidation:A}=Z(),{defaultRequiredRule:w}=ye(),I=B(()=>({add:"新增订单",edit:"查看订单详情"})[a.operateType]),n=N(S());function S(){return{orderId:"",userId:"",orderAmount:0,orderStatus:1,addressId:"",couponId:"",assignid:"",reconId:""}}const R={orderId:w,userId:w,orderAmount:w},O=B(()=>Object.entries(V).map(([p,u])=>({label:u,value:Number(p)})));function E(){Object.assign(n.value,S()),a.operateType==="edit"&&a.rowData&&Object.assign(n.value,{orderId:a.rowData.orderId,userId:a.rowData.userId,orderAmount:a.rowData.orderAmount,orderStatus:a.rowData.orderStatus,addressId:a.rowData.addressId,couponId:a.rowData.couponId,assignid:a.rowData.assignid,reconId:a.rowData.reconId})}function $(){s.value=!1}async function F(){await y(),console.log("提交数据:",n.value),window.$message?.success(a.operateType==="add"?"新增成功":"更新成功"),$(),f("submitted")}const U=B(()=>a.rowData?.createAt?new Date(a.rowData.createAt).toLocaleString("zh-CN"):"");return re(s,()=>{s.value&&(E(),A())}),(p,u)=>{const _=J,x=ge,g=ae,t=X,o=ee,d=T,k=te,b=oe,C=se;return z(),j(C,{show:s.value,"onUpdate:show":u[8]||(u[8]=c=>s.value=c),"display-directive":"show",width:420},{default:l(()=>[e(b,{title:I.value,"native-scrollbar":!1,closable:""},{footer:l(()=>[e(k,{justify:"end"},{default:l(()=>[e(d,{onClick:$},{default:l(()=>[v(Q(p.operateType==="edit"?"关闭":"取消"),1)]),_:1}),p.operateType==="add"||p.operateType==="edit"?(z(),j(d,{key:0,type:"primary",onClick:F},{default:l(()=>[v(Q(p.operateType==="edit"?"更新状态":"确定"),1)]),_:1})):G("",!0)]),_:1})]),default:l(()=>[e(o,{ref_key:"formRef",ref:h,model:n.value,rules:R},{default:l(()=>[e(x,{label:"订单ID",path:"orderId"},{default:l(()=>[e(_,{value:n.value.orderId,"onUpdate:value":u[0]||(u[0]=c=>n.value.orderId=c),placeholder:"请输入订单ID",readonly:p.operateType==="edit"},null,8,["value","readonly"])]),_:1}),e(x,{label:"用户ID",path:"userId"},{default:l(()=>[e(_,{value:n.value.userId,"onUpdate:value":u[1]||(u[1]=c=>n.value.userId=c),placeholder:"请输入用户ID",readonly:p.operateType==="edit"},null,8,["value","readonly"])]),_:1}),e(x,{label:"订单金额",path:"orderAmount"},{default:l(()=>[e(g,{value:n.value.orderAmount,"onUpdate:value":u[2]||(u[2]=c=>n.value.orderAmount=c),placeholder:"请输入订单金额",precision:2,min:0,class:"w-full",readonly:p.operateType==="edit"},{prefix:l(()=>u[9]||(u[9]=[v("¥")])),_:1},8,["value","readonly"])]),_:1}),e(x,{label:"订单状态",path:"orderStatus"},{default:l(()=>[e(t,{value:n.value.orderStatus,"onUpdate:value":u[3]||(u[3]=c=>n.value.orderStatus=c),placeholder:"请选择订单状态",options:O.value,disabled:p.operateType==="edit"},null,8,["value","options","disabled"])]),_:1}),e(x,{label:"地址信息",path:"addressId"},{default:l(()=>[e(_,{value:n.value.addressId,"onUpdate:value":u[4]||(u[4]=c=>n.value.addressId=c),placeholder:"请输入地址信息",type:"textarea",autosize:{minRows:2,maxRows:4},readonly:p.operateType==="edit"},null,8,["value","readonly"])]),_:1}),e(x,{label:"优惠券ID",path:"couponId"},{default:l(()=>[e(_,{value:n.value.couponId,"onUpdate:value":u[5]||(u[5]=c=>n.value.couponId=c),placeholder:"请输入优惠券ID",readonly:p.operateType==="edit"},null,8,["value","readonly"])]),_:1}),e(x,{label:"分配ID",path:"assignid"},{default:l(()=>[e(_,{value:n.value.assignid,"onUpdate:value":u[6]||(u[6]=c=>n.value.assignid=c),placeholder:"请输入分配ID",readonly:p.operateType==="edit"},null,8,["value","readonly"])]),_:1}),e(x,{label:"对账ID",path:"reconId"},{default:l(()=>[e(_,{value:n.value.reconId,"onUpdate:value":u[7]||(u[7]=c=>n.value.reconId=c),placeholder:"请输入对账ID",readonly:p.operateType==="edit"},null,8,["value","readonly"])]),_:1}),p.operateType==="edit"?(z(),j(x,{key:0,label:"创建时间"},{default:l(()=>[e(_,{value:U.value,readonly:""},null,8,["value"])]),_:1})):G("",!0)]),_:1},8,["model"])]),_:1},8,["title"])]),_:1},8,["show"])}}}),Ne={class:"min-h-500px flex-col-stretch gap-16px overflow-hidden lt-sm:overflow-auto"};function Ce(m){return typeof m=="function"||Object.prototype.toString.call(m)==="[object Object]"&&!ce(m)}const ze=L({name:"order-management",__name:"index",setup(m){const i=ne(),a=le(),f=N(!1),s=N([]),h=N([]),y=N([]),A=N(!1),w=N("add"),I=N(null),n=de({orderId:null,orderStatus:null}),S=async()=>{f.value=!0;try{console.log("开始获取订单数据，商家ID:",a.merchantId);const t=[0,1,2,3,4,5,6,7,8].map(r=>De(a.merchantId,{orderStatus:r})),o=await Promise.all(t);let d=[];if(o.forEach(r=>{const D=r?.data;Array.isArray(D)&&(d=d.concat(D))}),console.log("获取到订单ID列表:",d),d.length===0){console.log("没有找到订单数据"),h.value=[],s.value=[];return}const k=await be(d);if(console.log("获取到订单详情:",k.length,"条记录"),k.length===0){console.log("所有订单详情获取失败或无有效订单"),window.$message?.warning("未能获取到有效的订单详情信息"),h.value=[],s.value=[];return}console.log("订单详情数据样例:",k[0]);const b=k.map(r=>({orderId:r.OrderId||r.orderId||"",merchantId:r.MerchantId||r.merchantId||a.merchantId,userId:r.UserId||r.userId||"",addressId:r.AddressId||r.addressId||"",orderAmount:Number(r.OrderAmount||r.orderAmount||0),createAt:r.CreateAt||r.createAt||"",orderStatus:Number(r.OrderStatus||r.orderStatus||0),reconId:r.ReconId||r.reconId||"",couponId:r.CouponId||r.couponId||"",assignId:r.AssignId||r.assignId||"",orderDishes:Array.isArray(r.OrderDishes)?r.OrderDishes.map(D=>({dishId:D.DishId||D.dishId||"",quantity:Number(D.Quantity||D.quantity||0)})):Array.isArray(r.orderDishes)?r.orderDishes:[],orderLogIds:r.OrderLogIds||r.orderLogIds||[],paymentIds:r.PaymentIds||r.paymentIds||[],refundIds:r.RefundIds||r.refundIds||[],complaintIds:r.ComplaintIds||r.complaintIds||[],reviewIds:r.ReviewIds||r.reviewIds||[]})),C=new Set;b.forEach(r=>{r.orderDishes.forEach(D=>{D.dishId&&C.add(D.dishId)})}),console.log("订单涉及的菜品ID:",Array.from(C));let c={};if(C.size>0)try{c=await Se(a.merchantId,Array.from(C)),console.log("获取到菜品详情:",c)}catch(r){console.error("获取菜品详情失败:",r),window.$message?.warning("获取菜品详情失败，订单中菜品信息可能不完整")}const M=b.map(r=>({...r,orderDishes:r.orderDishes.map(D=>({...D,dishDetails:c[D.dishId]||null}))}));M.sort((r,D)=>new Date(D.createAt).getTime()-new Date(r.createAt).getTime()),h.value=M,s.value=M,console.log("成功获取订单详细数据（包含菜品详情）:",M.length,"条记录"),console.log("最终数据赋值给data.value:",s.value.length,"条")}catch(g){console.error("获取订单数据失败:",g);let t="获取订单数据失败";g?.response?.status===401?t="认证失败，请重新登录":g?.response?.status===403?t="权限不足，无法访问订单数据":g?.response?.status===404?t="API端点不存在，请检查后端服务状态":g?.code==="ERR_NETWORK"&&(t="网络连接失败，请检查后端服务是否运行"),window.$message?.error(t),h.value=[],s.value=[]}finally{f.value=!1}},R=()=>{let g=[...h.value];if(n.orderId&&n.orderId.trim()&&(g=g.filter(t=>t.orderId.toLowerCase().includes(n.orderId.toLowerCase()))),n.orderStatus!==null&&n.orderStatus!==void 0){const t=Number(n.orderStatus);g=g.filter(o=>Number(o.orderStatus)===t)}s.value=g},O=()=>{R()},E=()=>{Object.assign(n,{orderId:null,orderStatus:null}),s.value=[...h.value]},$=()=>{w.value="add",I.value=null,A.value=!0},F=g=>{const t=s.value.find(o=>o.orderId===g);t&&(w.value="edit",I.value=t,A.value=!0)},U=()=>{console.log("批量删除:",y.value),y.value=[],S()},p=()=>{S()},u=()=>{S()},_=N([{key:"selection",title:"选择",checked:!0},{key:"orderSummary",title:"订单概要",checked:!0},{key:"customerInfo",title:"客户信息",checked:!0},{key:"dishDetails",title:"菜品详情",checked:!0},{key:"orderAmount",title:"订单金额",checked:!0},{key:"orderStatus",title:"订单状态",checked:!0},{key:"createAt",title:"下单时间",checked:!0},{key:"dishCount",title:"菜品数量",checked:!1},{key:"paymentInfo",title:"支付信息",checked:!1},{key:"addressInfo",title:"配送地址",checked:!1},{key:"operate",title:"操作",checked:!0}]),x=B(()=>[{type:"selection",align:"center",width:48},{key:"orderSummary",title:"订单概要",align:"left",width:200,render:t=>{const o=t.orderDishes?.length||0,d=t.orderId.slice(-6),k=t.orderAmount?`¥${t.orderAmount.toFixed(2)}`:"¥0.00";return e("div",{class:"flex-col gap-4px"},[e("div",{class:"text-sm font-semibold"},[v("#"),d]),e("div",{class:"text-xs text-gray-600"},[o>0?`${o}种菜品 | ${k}`:"订单详情"])])}},{key:"customerInfo",title:"客户信息",align:"left",width:120,render:t=>{const o=t.userId?t.userId.slice(-6):"未知用户";return e("div",{class:"flex-col gap-4px"},[e("div",{class:"text-sm"},[v("用户"),o]),t.couponId&&e("div",{class:"text-xs text-blue-600"},[v("使用优惠券")])])}},{key:"dishDetails",title:"菜品详情",align:"left",width:300,render:t=>{const o=t.orderDishes||[];return o.length===0?e("div",{class:"text-sm text-gray-500"},[v("无菜品信息")]):e("div",{class:"flex-col gap-8px max-h-120px overflow-y-auto"},[o.map((d,k)=>{const b=d.dishDetails,C=b?.dishName||`菜品${d.dishId.slice(-4)}`,c=b?.price?`¥${b.price.toFixed(2)}`:"价格未知";return e("div",{key:d.dishId,class:"flex justify-between items-center text-sm border-b border-gray-100 pb-4px last:border-b-0"},[e("div",{class:"flex-col flex-1"},[e("div",{class:"font-medium text-gray-800"},[C]),e("div",{class:"text-xs text-gray-500"},[v("单价: "),c])]),e("div",{class:"text-right ml-8px"},[e("div",{class:"font-semibold text-orange-600"},[v("x"),d.quantity]),e("div",{class:"text-xs text-gray-500"},[b?.price?`¥${(b.price*d.quantity).toFixed(2)}`:"-"])])])})])}},{key:"orderAmount",title:"订单金额",align:"center",width:100,render:t=>e("div",{class:"font-semibold text-orange-600"},[v("¥"),t.orderAmount.toFixed(2)])},{key:"orderStatus",title:"订单状态",align:"center",width:100,render:t=>{const o=xe(t.orderStatus);let d="default";switch(t.orderStatus){case 1:d="success";break;case 2:d="info";break;case 3:d="success";break;case 4:d="warning";break;case 7:d="warning";break;case 8:d="info";break;default:d="default"}return e(ue,{type:d},Ce(o)?o:{default:()=>[o]})}},{key:"createAt",title:"下单时间",align:"center",width:140,render:t=>{const o=new Date(t.createAt);return e("div",{class:"flex-col gap-4px"},[e("div",{class:"text-sm"},[o.toLocaleDateString("zh-CN")]),e("div",{class:"text-xs text-gray-500"},[o.toLocaleTimeString("zh-CN",{hour:"2-digit",minute:"2-digit"})])])}},{key:"dishCount",title:"菜品数量",align:"center",width:80,render:t=>{const o=t.orderDishes?.reduce((k,b)=>k+(b.quantity||0),0)||0,d=t.orderDishes?.length||0;return e("div",{class:"text-center"},[e("div",{class:"text-sm font-semibold"},[o]),e("div",{class:"text-xs text-gray-500"},[d,v("种菜品 "),o,v("份")])])}},{key:"paymentInfo",title:"支付信息",align:"center",width:120,render:t=>{const o=t.paymentIds?.length||0;return o>0?`${o}笔支付`:"无支付记录"}},{key:"addressInfo",title:"配送地址",align:"left",width:200,ellipsis:{tooltip:!0},render:t=>{const o=t.addressId?t.addressId.slice(-6):"";return o?`地址${o}`:"无地址信息"}},{key:"operate",title:"操作",align:"center",width:160,render:t=>e("div",{class:"flex-center gap-8px"},[e(T,{type:"primary",ghost:!0,size:"small",onClick:()=>F(t.orderId)},{default:()=>[v("查看详情")]}),t.orderStatus===1&&e(T,{type:"success",ghost:!0,size:"small"},{default:()=>[v("确认订单")]}),t.orderStatus===4&&e(T,{type:"warning",ghost:!0,size:"small"},{default:()=>[v("处理售后")]}),t.orderStatus===7&&e(T,{type:"warning",ghost:!0,size:"small"},{default:()=>[v("确认送达")]}),t.orderStatus===8&&e(T,{type:"info",ghost:!0,size:"small"},{default:()=>[v("开始配送")]})])}].filter(t=>_.value.find(d=>d.key===t.key)?.checked!==!1));return S(),(g,t)=>(z(),ie("div",Ne,[e(ke,{model:n,"onUpdate:model":t[0]||(t[0]=o=>n=o),onSearch:O,onReset:E},null,8,["model"]),e(P(Y),{title:"订单管理",bordered:!1,size:"small",class:"card-wrapper sm:flex-1-hidden"},{"header-extra":l(()=>[e(he,{columns:_.value,"onUpdate:columns":t[1]||(t[1]=o=>_.value=o),"disabled-delete":y.value.length===0,loading:f.value,onAdd:$,onDelete:U,onRefresh:p},null,8,["columns","disabled-delete","loading"])]),default:l(()=>[e(P(_e),{"checked-row-keys":y.value,"onUpdate:checkedRowKeys":t[2]||(t[2]=o=>y.value=o),columns:x.value,data:s.value,size:"small","flex-height":!P(i).isMobile,"scroll-x":1200,loading:f.value,remote:"","row-key":o=>o.orderId,class:"sm:h-full"},null,8,["checked-row-keys","columns","data","flex-height","loading","row-key"]),e(Ae,{visible:A.value,"onUpdate:visible":t[3]||(t[3]=o=>A.value=o),"operate-type":w.value,"row-data":I.value,onSubmitted:u},null,8,["visible","operate-type","row-data"])]),_:1})]))}});export{ze as default};
