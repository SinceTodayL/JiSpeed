import{at as S,d as z,m as T,aw as C,r as m,n as E,aj as B,b as M,o as j,f as a,w,e as I,h as g,K as x,N as F,B as y,g as f,aA as O,aS as U,y as K}from"./index-TrO1w1dX.js";import{N as V,a as D}from"./Popconfirm-D7RUfCHW.js";import{N as q}from"./Space-xizCH3US.js";import"./RadioGroup-UM9eJ2Tm.js";function L(o,r){const l=new URLSearchParams;r?.size&&l.append("size",r.size.toString()),r?.page&&l.append("page",r.page.toString()),r?.auditStatus!==void 0&&l.append("auditStatus",r.auditStatus.toString());const c=l.toString(),u=`/api/merchants/${o}/refunds${c?`?${c}`:""}`;return S({url:u,method:"get"})}function J(o,r){return S({url:`/api/merchants/${o}/refunds/${r}/approve`,method:"patch",data:{}})}function Q(o,r){return S({url:`/api/merchants/${o}/refunds/${r}/reject`,method:"patch"})}const k={0:"默认状态",1:"商家拒绝",2:"商家退款",3:"等待管理员处理",4:"管理员拒绝退款",5:"管理员同意退款"};function W(o){return S({url:`/api/refunds/${o}`,method:"get"})}async function G(o){try{console.log("=== 开始批量获取退款详情 ==="),console.log("退款ID列表:",o);const r=o.map(u=>W(u).then(d=>(console.log(`退款${u}获取成功:`,d),d?.data||null)).catch(d=>(console.warn(`获取退款详情失败 ${u}:`,d),null))),c=(await Promise.all(r)).filter(u=>u!==null);return console.log("批量获取退款详情结果:",c),c}catch(r){return console.error("批量获取退款详情失败:",r),[]}}function H(o){return k[o]||"未知状态"}const X={class:"min-h-500px flex-col-stretch gap-16px overflow-hidden <sm:overflow-auto"},Y={class:"mb-4"},Z={class:"flex items-center gap-4"};function ee(o){return typeof o=="function"||Object.prototype.toString.call(o)==="[object Object]"&&!U(o)}const te=z({name:"refund-management",__name:"index",setup(o){const r=T(),l=C(),c=m([]),u=m(!1),d=m([]),p=E({auditStatus:0}),v=m([]),A=[{label:"全部",value:null},{label:"待处理",value:0},{label:"商家拒绝",value:1},{label:"商家退款",value:2},{label:"等待管理员处理",value:3},{label:"管理员拒绝",value:4},{label:"管理员同意",value:5}],h=async()=>{u.value=!0;try{if(console.log("开始获取退款申请数据，商家ID:",l.merchantId),!l.merchantId){console.warn("商家ID为空，无法获取退款数据"),u.value=!1;return}const s=await L(l.merchantId,{auditStatus:p.auditStatus||void 0});console.log("获取到退款申请ID列表:",s);const t=s?.data;if(Array.isArray(t)&&t.length>0){console.log("获取到退款申请ID:",t.length,"个");const e=await G(t);if(console.log("获取到退款详情:",e.length,"条记录"),e.length>0){console.log("=== 退款数据状态分析 ==="),e.forEach((n,P)=>{console.log(`退款${P+1}:`,{refundId:n.refundId,auditStatus:n.auditStatus,statusText:k[n.auditStatus]||"未知状态",canOperate:n.auditStatus===0?"✅ 可操作":"❌ 不可操作"})});const i=e.filter(n=>n.auditStatus===0).length;console.log(`总计 ${e.length} 条退款，其中 ${i} 条可操作`),d.value=e,c.value=[...e],i===0&&p.auditStatus===0&&window.$message?.info("当前没有待处理的退款申请")}else console.log("所有退款详情获取失败或无有效退款"),window.$message?.warning("未能获取到有效的退款详情信息"),d.value=[],c.value=[]}else console.log("没有找到退款申请数据"),d.value=[],c.value=[]}catch(s){console.error("获取退款申请数据失败:",s);let t="获取退款数据失败，请稍后重试";const e=s;e?.response?.status===401?t="认证失败，请重新登录":e?.response?.status===403?t="权限不足，无法访问退款数据":e?.response?.status===404?t="API端点不存在，请检查后端服务状态":e?.code==="ERR_NETWORK"&&(t="网络连接失败，请检查后端服务是否运行"),window.$message?.error(t),d.value=[],c.value=[]}finally{u.value=!1}},b=async s=>{if(!l.merchantId){window.$message?.error("商家信息未找到，无法操作");return}try{console.log("=== 商家同意退款申请 ==="),console.log("商家ID:",l.merchantId),console.log("退款ID:",s);const t=await J(l.merchantId,s);console.log("同意退款API响应:",t);const e=t;let i=!1,n="";e?.data===!0||e?.code===0?(i=!0,n=e?.message||"退款申请已同意"):e===!0&&(i=!0,n="退款申请已同意"),i?(window.$message?.success(n),console.log("同意退款成功，开始刷新数据"),await h()):(console.warn("同意退款失败，API返回:",t),window.$message?.error(n||"同意退款失败"))}catch(t){console.error("同意退款API调用失败:",t);const e=t,i=e?.response?.data?.message||e?.message||"同意退款失败，请重试";window.$message?.error(i)}},$=async s=>{if(!l.merchantId){window.$message?.error("商家信息未找到，无法操作");return}try{console.log("=== 商家拒绝退款申请 ==="),console.log("商家ID:",l.merchantId),console.log("退款ID:",s);const t=await Q(l.merchantId,s);console.log("拒绝退款API响应:",t);const e=t;let i=!1,n="";e?.data===!0||e?.code===0?(i=!0,n=e?.message||"退款申请已拒绝"):e===!0&&(i=!0,n="退款申请已拒绝"),i?(window.$message?.success(n),console.log("拒绝退款成功，开始刷新数据"),await h()):(console.warn("拒绝退款失败，API返回:",t),window.$message?.error(n||"拒绝退款失败"))}catch(t){console.error("拒绝退款API调用失败:",t);const e=t,i=e?.response?.data?.message||e?.message||"拒绝退款失败，请重试";window.$message?.error(i)}},_=()=>{h()},R=()=>{p.auditStatus=0,h()},N=[{type:"selection",disabled(s){return s.auditStatus!==1}},{key:"index",title:"序号",width:60,render:(s,t)=>t+1},{key:"refundId",title:"退款申请ID",width:140,ellipsis:{tooltip:!0},render:s=>a("span",{class:"text-blue-600"},[s.refundId.slice(-8)])},{key:"orderId",title:"关联订单ID",width:140,ellipsis:{tooltip:!0},render:s=>a("span",{class:"text-purple-600"},[s.orderId.slice(-8)])},{key:"refundAmount",title:"退款金额",width:120,render:s=>a("span",{class:"text-green-600 font-semibold"},[f("¥"),(s.refundAmount/100).toFixed(2)])},{key:"reason",title:"退款理由",width:150,ellipsis:{tooltip:!0},render:s=>a("span",null,[s.reason||"无"])},{key:"auditStatus",title:"审核状态",width:100,render:s=>{const t=H(s.auditStatus);let e="default";switch(s.auditStatus){case 0:e="warning";break;case 1:e="error";break;case 2:e="success";break;case 3:e="info";break;case 4:e="error";break;case 5:e="success";break;default:e="default"}return a(O,{type:e},ee(t)?t:{default:()=>[t]})}},{key:"applyAt",title:"申请时间",width:160,render:s=>a("span",{class:"text-gray-600"},[new Date(s.applyAt).toLocaleString("zh-CN",{month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"})])},{key:"finishAt",title:"处理时间",width:160,render:s=>a("span",{class:"text-gray-600"},[s.finishAt?new Date(s.finishAt).toLocaleString("zh-CN",{month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit"}):"未处理"])},{key:"operate",title:"操作",width:180,fixed:"right",render:s=>(console.log(`渲染操作列 - 退款ID: ${s.refundId}, 状态: ${s.auditStatus}, 可操作: ${s.auditStatus===0}`),s.auditStatus!==0?a("span",{class:"text-gray-400"},[f("已处理")]):a(q,{size:8},{default:()=>[a(D,{onPositiveClick:()=>b(s.refundId),positiveText:"确认同意",negativeText:"取消"},{default:()=>"确认同意此退款申请？",trigger:()=>a(y,{size:"small",type:"success",ghost:!0},{default:()=>[f("同意退款")]})}),a(D,{onPositiveClick:()=>$(s.refundId),positiveText:"确认拒绝",negativeText:"取消"},{default:()=>"确认拒绝此退款申请？",trigger:()=>a(y,{size:"small",type:"error",ghost:!0},{default:()=>[f("拒绝退款")]})})]}))}];return B(()=>{h()}),(s,t)=>(j(),M("div",X,[a(g(x),{title:"退款管理",bordered:!1,size:"small",class:"sm:flex-1-hidden card-wrapper"},{default:w(()=>[I("div",Y,[a(g(x),{bordered:!1,size:"small"},{default:w(()=>[I("div",Z,[a(g(F),{value:p.auditStatus,"onUpdate:value":t[0]||(t[0]=e=>p.auditStatus=e),options:A,placeholder:"审核状态",clearable:"",class:"w-200px"},null,8,["value"]),a(g(y),{type:"primary",onClick:_},{default:w(()=>t[2]||(t[2]=[f(" 搜索 ")])),_:1,__:[2]}),a(g(y),{onClick:R},{default:w(()=>t[3]||(t[3]=[f(" 重置 ")])),_:1,__:[3]})])]),_:1})]),a(g(V),{"checked-row-keys":v.value,"onUpdate:checkedRowKeys":t[1]||(t[1]=e=>v.value=e),columns:N,data:c.value,size:"small",loading:u.value,"scroll-x":1170,"flex-height":!g(r).isMobile,"row-key":e=>e.refundId,pagination:{pageSize:20,showSizePicker:!0,showQuickJumper:!0,pageSizes:[10,20,50,100]},"single-line":!1,class:"sm:h-full"},null,8,["checked-row-keys","data","loading","flex-height","row-key"])]),_:1})]))}}),ne=K(te,[["__scopeId","data-v-ddd14542"]]);export{ne as default};
