import{at as m,d as R,m as I,aw as N,r as p,n as $,aj as z,b as T,o as C,f as r,w as h,e as y,h as c,K as v,N as B,B as g,g as d,aA as E,aS as P,y as j}from"./index-Bojb7anf.js";import{N as F,a as S}from"./Popconfirm-BihLH5RL.js";import{N as M}from"./Space-D__Tmt69.js";import"./RadioGroup-DSc9emlt.js";function U(n,a){const l=new URLSearchParams;a?.size&&l.append("size",a.size.toString()),a?.page&&l.append("page",a.page.toString()),a?.auditStatus!==void 0&&l.append("auditStatus",a.auditStatus.toString());const u=l.toString(),o=`/api/merchants/${n}/refunds${u?`?${u}`:""}`;return m({url:o,method:"get"})}function K(n,a){return m({url:`/api/merchants/${n}/refunds/${a}/approve`,method:"patch",data:{}})}function O(n,a){return m({url:`/api/merchants/${n}/refunds/${a}/reject`,method:"patch"})}const V={0:"默认状态",1:"商家拒绝",2:"商家退款",3:"等待管理员处理",4:"管理员拒绝退款",5:"管理员同意退款"};function q(n){return m({url:`/api/refunds/${n}`,method:"get"})}async function L(n){try{console.log("=== 开始批量获取退款详情 ==="),console.log("退款ID列表:",n);const a=n.map(o=>q(o).then(i=>(console.log(`退款${o}获取成功:`,i),i?.data||null)).catch(i=>(console.warn(`获取退款详情失败 ${o}:`,i),null))),u=(await Promise.all(a)).filter(o=>o!==null);return console.log("批量获取退款详情结果:",u),u}catch(a){return console.error("批量获取退款详情失败:",a),[]}}function J(n){return V[n]||"未知状态"}const Q={class:"min-h-500px flex-col-stretch gap-16px overflow-hidden <sm:overflow-auto"},W={class:"mb-4"},G={class:"flex items-center gap-4"};function H(n){return typeof n=="function"||Object.prototype.toString.call(n)==="[object Object]"&&!P(n)}const X=R({name:"refund-management",__name:"index",setup(n){I();const a=N(),l=p([]),u=p(!1),o=p([]),i=$({auditStatus:null}),w=p([]),k=[{label:"全部",value:null},{label:"待处理",value:1},{label:"已同意",value:2},{label:"已拒绝",value:3}],f=async()=>{u.value=!0;try{if(console.log("开始获取退款申请数据，商家ID:",a.merchantId),!a.merchantId){console.warn("商家ID为空，无法获取退款数据"),u.value=!1;return}const t=await U(a.merchantId,{auditStatus:i.auditStatus||void 0});console.log("获取到退款申请ID列表:",t);const e=t?.data;if(Array.isArray(e)&&e.length>0){console.log("获取到退款申请ID:",e.length,"个");const s=await L(e);console.log("获取到退款详情:",s.length,"条记录"),s.length>0?(o.value=s,l.value=[...s]):(console.log("所有退款详情获取失败或无有效退款"),window.$message?.warning("未能获取到有效的退款详情信息"),o.value=[],l.value=[])}else console.log("没有找到退款申请数据"),o.value=[],l.value=[]}catch(t){console.error("获取退款申请数据失败:",t);let e="获取退款数据失败，请稍后重试";const s=t;s?.response?.status===401?e="认证失败，请重新登录":s?.response?.status===403?e="权限不足，无法访问退款数据":s?.response?.status===404?e="API端点不存在，请检查后端服务状态":s?.code==="ERR_NETWORK"&&(e="网络连接失败，请检查后端服务是否运行"),window.$message?.error(e),o.value=[],l.value=[]}finally{u.value=!1}},D=async t=>{try{await K(a.merchantId,t)&&(window.$message?.success("退款申请已同意"),await f())}catch(e){console.error("同意退款失败:",e),window.$message?.error("同意退款失败，请重试")}},x=async t=>{try{await O(a.merchantId,t)&&(window.$message?.success("退款申请已拒绝"),await f())}catch(e){console.error("拒绝退款失败:",e),window.$message?.error("拒绝退款失败，请重试")}},_=()=>{f()},A=()=>{i.auditStatus=null,f()},b=[{type:"selection",disabled(t){return t.auditStatus!==1}},{key:"index",title:"序号",width:60,render:(t,e)=>e+1},{key:"refundId",title:"退款申请ID",width:200,ellipsis:{tooltip:!0}},{key:"orderId",title:"关联订单ID",width:200,ellipsis:{tooltip:!0}},{key:"refundAmount",title:"退款金额",width:120,render:t=>r("span",{class:"text-green-600 font-semibold"},[d("¥"),(t.refundAmount/100).toFixed(2)])},{key:"reason",title:"退款理由",width:200,ellipsis:{tooltip:!0},render:t=>r("span",null,[t.reason||"无"])},{key:"auditStatus",title:"审核状态",width:100,render:t=>{const e=J(t.auditStatus);let s="default";switch(t.auditStatus){case 1:s="warning";break;case 2:s="success";break;case 3:s="error";break}return r(E,{type:s},H(e)?e:{default:()=>[e]})}},{key:"applyAt",title:"申请时间",width:180,render:t=>r("span",null,[new Date(t.applyAt).toLocaleString("zh-CN")])},{key:"finishAt",title:"处理时间",width:180,render:t=>r("span",null,[t.finishAt?new Date(t.finishAt).toLocaleString("zh-CN"):"未处理"])},{key:"operate",title:"操作",width:200,render:t=>t.auditStatus!==1?r("span",{class:"text-gray-400"},[d("已处理")]):r(M,{size:8},{default:()=>[r(S,{onPositiveClick:()=>D(t.refundId),positiveText:"确认同意",negativeText:"取消"},{default:()=>"确认同意此退款申请？",trigger:()=>r(g,{size:"small",type:"success",ghost:!0},{default:()=>[d("同意退款")]})}),r(S,{onPositiveClick:()=>x(t.refundId),positiveText:"确认拒绝",negativeText:"取消"},{default:()=>"确认拒绝此退款申请？",trigger:()=>r(g,{size:"small",type:"error",ghost:!0},{default:()=>[d("拒绝退款")]})})]})}];return z(()=>{f()}),(t,e)=>(C(),T("div",Q,[r(c(v),{title:"退款管理",bordered:!1,size:"small",class:"sm:flex-1-hidden card-wrapper"},{default:h(()=>[y("div",W,[r(c(v),{bordered:!1,size:"small"},{default:h(()=>[y("div",G,[r(c(B),{value:i.auditStatus,"onUpdate:value":e[0]||(e[0]=s=>i.auditStatus=s),options:k,placeholder:"审核状态",clearable:"",class:"w-200px"},null,8,["value"]),r(c(g),{type:"primary",onClick:_},{default:h(()=>e[2]||(e[2]=[d(" 搜索 ")])),_:1,__:[2]}),r(c(g),{onClick:A},{default:h(()=>e[3]||(e[3]=[d(" 重置 ")])),_:1,__:[3]})])]),_:1})]),r(c(F),{"checked-row-keys":w.value,"onUpdate:checkedRowKeys":e[1]||(e[1]=s=>w.value=s),columns:b,data:l.value,size:"small",loading:u.value,"row-key":s=>s.refundId,pagination:{pageSize:20,showSizePicker:!0,showQuickJumper:!0,pageSizes:[10,20,50,100]},"single-line":!1,class:"sm:h-320px"},null,8,["checked-row-keys","data","loading","row-key"])]),_:1})]))}}),ae=j(X,[["__scopeId","data-v-2d8f091e"]]);export{ae as default};
