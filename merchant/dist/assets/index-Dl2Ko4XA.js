import{at as y,d as R,m as N,aw as P,r as m,n as z,aj as T,b as C,o as B,f as r,w as h,e as S,h as f,K as k,N as E,B as w,g,aA as j,aS as M,y as F}from"./index-Cc1DHHeB.js";import{N as U,a as D}from"./Popconfirm-CEi_CUHF.js";import{N as K}from"./Space-BmBnjvHW.js";import"./RadioGroup-Ct9dCgBh.js";function O(o,a){const l=new URLSearchParams;a?.size&&l.append("size",a.size.toString()),a?.page&&l.append("page",a.page.toString()),a?.auditStatus!==void 0&&l.append("auditStatus",a.auditStatus.toString());const i=l.toString(),n=`/api/merchants/${o}/refunds${i?`?${i}`:""}`;return y({url:n,method:"get"})}function V(o,a){return y({url:`/api/merchants/${o}/refunds/${a}/approve`,method:"patch",data:{}})}function q(o,a){return y({url:`/api/merchants/${o}/refunds/${a}/reject`,method:"patch"})}const L={0:"默认状态",1:"商家拒绝",2:"商家退款",3:"等待管理员处理",4:"管理员拒绝退款",5:"管理员同意退款"};function J(o){return y({url:`/api/refunds/${o}`,method:"get"})}async function Q(o){try{console.log("=== 开始批量获取退款详情 ==="),console.log("退款ID列表:",o);const a=o.map(n=>J(n).then(c=>(console.log(`退款${n}获取成功:`,c),c?.data||null)).catch(c=>(console.warn(`获取退款详情失败 ${n}:`,c),null))),i=(await Promise.all(a)).filter(n=>n!==null);return console.log("批量获取退款详情结果:",i),i}catch(a){return console.error("批量获取退款详情失败:",a),[]}}function W(o){return L[o]||"未知状态"}const G={class:"min-h-500px flex-col-stretch gap-16px overflow-hidden <sm:overflow-auto"},H={class:"mb-4"},X={class:"flex items-center gap-4"};function Y(o){return typeof o=="function"||Object.prototype.toString.call(o)==="[object Object]"&&!M(o)}const Z=R({name:"refund-management",__name:"index",setup(o){N();const a=P(),l=m([]),i=m(!1),n=m([]),c=z({auditStatus:null}),v=m([]),A=[{label:"全部",value:null},{label:"待处理",value:0},{label:"商家拒绝",value:1},{label:"商家退款",value:2},{label:"等待管理员处理",value:3},{label:"管理员拒绝",value:4},{label:"管理员同意",value:5}],p=async()=>{i.value=!0;try{if(console.log("开始获取退款申请数据，商家ID:",a.merchantId),!a.merchantId){console.warn("商家ID为空，无法获取退款数据"),i.value=!1;return}const s=await O(a.merchantId,{auditStatus:c.auditStatus||void 0});console.log("获取到退款申请ID列表:",s);const t=s?.data;if(Array.isArray(t)&&t.length>0){console.log("获取到退款申请ID:",t.length,"个");const e=await Q(t);console.log("获取到退款详情:",e.length,"条记录"),e.length>0?(n.value=e,l.value=[...e]):(console.log("所有退款详情获取失败或无有效退款"),window.$message?.warning("未能获取到有效的退款详情信息"),n.value=[],l.value=[])}else console.log("没有找到退款申请数据"),n.value=[],l.value=[]}catch(s){console.error("获取退款申请数据失败:",s);let t="获取退款数据失败，请稍后重试";const e=s;e?.response?.status===401?t="认证失败，请重新登录":e?.response?.status===403?t="权限不足，无法访问退款数据":e?.response?.status===404?t="API端点不存在，请检查后端服务状态":e?.code==="ERR_NETWORK"&&(t="网络连接失败，请检查后端服务是否运行"),window.$message?.error(t),n.value=[],l.value=[]}finally{i.value=!1}},I=async s=>{if(!a.merchantId){window.$message?.error("商家信息未找到，无法操作");return}try{console.log("=== 商家同意退款申请 ==="),console.log("商家ID:",a.merchantId),console.log("退款ID:",s);const t=await V(a.merchantId,s);console.log("同意退款API响应:",t);const e=t;let u=!1,d="";e?.data===!0||e?.code===0?(u=!0,d=e?.message||"退款申请已同意"):e===!0&&(u=!0,d="退款申请已同意"),u?(window.$message?.success(d),console.log("同意退款成功，开始刷新数据"),await p()):(console.warn("同意退款失败，API返回:",t),window.$message?.error(d||"同意退款失败"))}catch(t){console.error("同意退款API调用失败:",t);const e=t,u=e?.response?.data?.message||e?.message||"同意退款失败，请重试";window.$message?.error(u)}},x=async s=>{if(!a.merchantId){window.$message?.error("商家信息未找到，无法操作");return}try{console.log("=== 商家拒绝退款申请 ==="),console.log("商家ID:",a.merchantId),console.log("退款ID:",s);const t=await q(a.merchantId,s);console.log("拒绝退款API响应:",t);const e=t;let u=!1,d="";e?.data===!0||e?.code===0?(u=!0,d=e?.message||"退款申请已拒绝"):e===!0&&(u=!0,d="退款申请已拒绝"),u?(window.$message?.success(d),console.log("拒绝退款成功，开始刷新数据"),await p()):(console.warn("拒绝退款失败，API返回:",t),window.$message?.error(d||"拒绝退款失败"))}catch(t){console.error("拒绝退款API调用失败:",t);const e=t,u=e?.response?.data?.message||e?.message||"拒绝退款失败，请重试";window.$message?.error(u)}},b=()=>{p()},_=()=>{c.auditStatus=null,p()},$=[{type:"selection",disabled(s){return s.auditStatus!==1}},{key:"index",title:"序号",width:60,render:(s,t)=>t+1},{key:"refundId",title:"退款申请ID",width:200,ellipsis:{tooltip:!0}},{key:"orderId",title:"关联订单ID",width:200,ellipsis:{tooltip:!0}},{key:"refundAmount",title:"退款金额",width:120,render:s=>r("span",{class:"text-green-600 font-semibold"},[g("¥"),(s.refundAmount/100).toFixed(2)])},{key:"reason",title:"退款理由",width:200,ellipsis:{tooltip:!0},render:s=>r("span",null,[s.reason||"无"])},{key:"auditStatus",title:"审核状态",width:100,render:s=>{const t=W(s.auditStatus);let e="default";switch(s.auditStatus){case 0:e="warning";break;case 1:e="error";break;case 2:e="success";break;case 3:e="info";break;case 4:e="error";break;case 5:e="success";break;default:e="default"}return r(j,{type:e},Y(t)?t:{default:()=>[t]})}},{key:"applyAt",title:"申请时间",width:180,render:s=>r("span",null,[new Date(s.applyAt).toLocaleString("zh-CN")])},{key:"finishAt",title:"处理时间",width:180,render:s=>r("span",null,[s.finishAt?new Date(s.finishAt).toLocaleString("zh-CN"):"未处理"])},{key:"operate",title:"操作",width:200,render:s=>s.auditStatus!==0?r("span",{class:"text-gray-400"},[g("已处理")]):r(K,{size:8},{default:()=>[r(D,{onPositiveClick:()=>I(s.refundId),positiveText:"确认同意",negativeText:"取消"},{default:()=>"确认同意此退款申请？",trigger:()=>r(w,{size:"small",type:"success",ghost:!0},{default:()=>[g("同意退款")]})}),r(D,{onPositiveClick:()=>x(s.refundId),positiveText:"确认拒绝",negativeText:"取消"},{default:()=>"确认拒绝此退款申请？",trigger:()=>r(w,{size:"small",type:"error",ghost:!0},{default:()=>[g("拒绝退款")]})})]})}];return T(()=>{p()}),(s,t)=>(B(),C("div",G,[r(f(k),{title:"退款管理",bordered:!1,size:"small",class:"sm:flex-1-hidden card-wrapper"},{default:h(()=>[S("div",H,[r(f(k),{bordered:!1,size:"small"},{default:h(()=>[S("div",X,[r(f(E),{value:c.auditStatus,"onUpdate:value":t[0]||(t[0]=e=>c.auditStatus=e),options:A,placeholder:"审核状态",clearable:"",class:"w-200px"},null,8,["value"]),r(f(w),{type:"primary",onClick:b},{default:h(()=>t[2]||(t[2]=[g(" 搜索 ")])),_:1,__:[2]}),r(f(w),{onClick:_},{default:h(()=>t[3]||(t[3]=[g(" 重置 ")])),_:1,__:[3]})])]),_:1})]),r(f(U),{"checked-row-keys":v.value,"onUpdate:checkedRowKeys":t[1]||(t[1]=e=>v.value=e),columns:$,data:l.value,size:"small",loading:i.value,"row-key":e=>e.refundId,pagination:{pageSize:20,showSizePicker:!0,showQuickJumper:!0,pageSizes:[10,20,50,100]},"single-line":!1,class:"sm:h-320px"},null,8,["checked-row-keys","data","loading","row-key"])]),_:1})]))}}),oe=F(Z,[["__scopeId","data-v-f5260246"]]);export{oe as default};
