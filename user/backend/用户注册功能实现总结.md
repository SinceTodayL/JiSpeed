# ç”¨æˆ·æ³¨å†ŒåŠŸèƒ½å®ç°æ€»ç»“

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

å®ç°äº†å®Œæ•´çš„ç”¨æˆ·æ³¨å†ŒåŠŸèƒ½ï¼Œå½“ç”¨æˆ·ç±»å‹ä¸º 1ï¼ˆæ™®é€šç”¨æˆ·ï¼‰æ—¶ï¼Œè‡ªåŠ¨åˆ›å»ºå¯¹åº”çš„ User å®ä½“å¹¶ä¿å­˜åˆ°æ•°æ®åº“ã€‚

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### æ ¸å¿ƒæœåŠ¡å±‚çº§

```
AuthController (APIå±‚)
    â†“
RegistrationService (Applicationå±‚)
    â†“
UserService + UserManager (Applicationå±‚)
    â†“
UserRepository (Infrastructureå±‚)
    â†“
Database (æ•°æ®åº“å±‚)
```

## ğŸ”§ å®ç°æ­¥éª¤è¯¦è§£

### 1. æ‰©å±•ç”¨æˆ·æœåŠ¡æ¥å£ (`IUserService.cs`)

- æ·»åŠ  `CreateUserEntityAsync` æ–¹æ³•ï¼šåˆ›å»º User å®ä½“
- æ·»åŠ  `GetUserByApplicationUserIdAsync` æ–¹æ³•ï¼šæ ¹æ® ApplicationUser ID è·å– User å®ä½“

### 2. æ‰©å±•ç”¨æˆ·ä»“å‚¨æ¥å£ (`IUserRepository.cs`)

- æ·»åŠ  `CreateAsync` æ–¹æ³•ï¼šåˆ›å»ºç”¨æˆ·å®ä½“
- æ·»åŠ  `GetUserByApplicationUserIdAsync` æ–¹æ³•ï¼šæŸ¥è¯¢å…³è”çš„ç”¨æˆ·
- æ·»åŠ  `SaveChangesAsync` æ–¹æ³•ï¼šä¿å­˜æ•°æ®åº“æ›´æ”¹

### 3. å®ç°ä»“å‚¨å±‚ (`UserRepository.cs`)

```csharp
public async Task<User> CreateAsync(User user)
{
    var entity = await _context.CustomUsers.AddAsync(user);
    return entity.Entity;
}

public async Task<User?> GetUserByApplicationUserIdAsync(string applicationUserId)
{
    return await _context.CustomUsers
        .Include(u => u.DefaultAddress)
        .Include(u => u.ApplicationUser)
        .FirstOrDefaultAsync(u => u.ApplicationUserId == applicationUserId);
}
```

### 4. æ‰©å±•ç”¨æˆ·æœåŠ¡å®ç° (`UserService.cs`)

```csharp
public async Task<User> CreateUserEntityAsync(ApplicationUser applicationUser, string? nickname = null)
{
    // å‚æ•°éªŒè¯
    if (applicationUser.UserType != 1)
        throw new ValidationException($"UserTypeå¿…é¡»ä¸º1ï¼Œå½“å‰å€¼: {applicationUser.UserType}");

    // æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨
    var existingUser = await _userRepository.GetUserByApplicationUserIdAsync(applicationUser.Id);
    if (existingUser != null)
        throw new BusinessException("ç”¨æˆ·å®ä½“å·²å­˜åœ¨");

    // åˆ›å»ºUserå®ä½“
    var userId = Guid.NewGuid().ToString("N");
    var userNickname = nickname ?? applicationUser.UserName ?? "ç”¨æˆ·" + userId.Substring(0, 8);
    var user = new User(userId, userNickname, applicationUser.Id);

    // ä¿å­˜åˆ°æ•°æ®åº“
    await _userRepository.CreateAsync(user);
    await _userRepository.SaveChangesAsync();

    return user;
}
```

### 5. åˆ›å»ºæ³¨å†ŒæœåŠ¡æ¥å£ (`IRegistrationService.cs`)

- å®šä¹‰ `RegisterUserAsync` æ–¹æ³•ï¼šå®Œæ•´çš„æ³¨å†Œæµç¨‹
- å®šä¹‰ `CreateBusinessEntityAsync` æ–¹æ³•ï¼šæ ¹æ® UserType åˆ›å»ºå¯¹åº”å®ä½“
- å®šä¹‰ `RegistrationResult` ç±»ï¼šç»Ÿä¸€çš„æ³¨å†Œç»“æœæ ¼å¼

### 6. å®ç°æ³¨å†ŒæœåŠ¡ (`RegistrationService.cs`)

æ ¸å¿ƒæ³¨å†Œæµç¨‹ï¼š

```csharp
public async Task<RegistrationResult> RegisterUserAsync(string userName, string password, int userType,
    string? email = null, string? nickname = null)
{
    // 1. å‚æ•°éªŒè¯
    // 2. æ£€æŸ¥ç”¨æˆ·å/é‚®ç®±æ˜¯å¦å·²å­˜åœ¨
    // 3. åˆ›å»ºApplicationUser
    // 4. æ ¹æ®UserTypeåˆ›å»ºå¯¹åº”çš„ä¸šåŠ¡å®ä½“
    // 5. è¿”å›æ³¨å†Œç»“æœ
}
```

### 7. æ‰©å±•æ³¨å†Œè¯·æ±‚æ¨¡å‹ (`UserRegisterRequest.cs`)

```csharp
public class UserRegisterRequest
{
    [Required] public required string UserName { get; set; }
    [Required] public required string PassWord { get; set; }
    [Range(1, 4)] public int UserType { get; set; }
    [EmailAddress] public string? Email { get; set; }
    [StringLength(50)] public string? Nickname { get; set; }
}
```

### 8. ä¿®æ”¹æ§åˆ¶å™¨ (`AuthController.cs`)

```csharp
[HttpPost("register")]
public async Task<ActionResult<ApiResponse<object>>> Register([FromBody] UserRegisterRequest request)
{
    var result = await _registrationService.RegisterUserAsync(
        request.UserName,
        request.PassWord,
        request.UserType,
        request.Email,
        request.Nickname);

    if (result.IsSuccess)
    {
        var responseData = new
        {
            ApplicationUserId = result.ApplicationUserId,
            BusinessEntityId = result.BusinessEntityId,
            UserType = request.UserType
        };
        return Ok(ApiResponse<object>.Success(responseData, "æ³¨å†ŒæˆåŠŸ"));
    }
    else
    {
        return BadRequest(ApiResponse<object>.Fail(ErrorCodes.ValidationFailed,
            string.Join("; ", result.Errors)));
    }
}
```

## ğŸ”„ å®Œæ•´æ³¨å†Œæµç¨‹

1. **å‰ç«¯å‘é€æ³¨å†Œè¯·æ±‚** â†’ `POST /api/auth/register`
2. **æ§åˆ¶å™¨æ¥æ”¶è¯·æ±‚** â†’ è°ƒç”¨ `RegistrationService.RegisterUserAsync`
3. **æ³¨å†ŒæœåŠ¡éªŒè¯å‚æ•°** â†’ æ£€æŸ¥ç”¨æˆ·åã€é‚®ç®±æ˜¯å¦å·²å­˜åœ¨
4. **åˆ›å»º ApplicationUser** â†’ ä½¿ç”¨ `UserManager.CreateAsync`
5. **æ ¹æ® UserType åˆ›å»ºä¸šåŠ¡å®ä½“**ï¼š
   - UserType=1 â†’ è°ƒç”¨ `UserService.CreateUserEntityAsync` åˆ›å»º User å®ä½“
   - UserType=2,3,4 â†’ é¢„ç•™æ¥å£ï¼Œå¾…åç»­å®ç°
6. **ä¿å­˜åˆ°æ•°æ®åº“** â†’ é€šè¿‡ `UserRepository.CreateAsync`
7. **è¿”å›æ³¨å†Œç»“æœ** â†’ åŒ…å« ApplicationUserId å’Œ BusinessEntityId

## ğŸ“Š æ•°æ®å…³ç³»

```
ApplicationUser (èº«ä»½éªŒè¯è¡¨)
    â†“ (OneToOne)
User (ä¸šåŠ¡å®ä½“è¡¨ - UserType=1)
    â†“ (OneToMany)
Address, CartItem, Order, etc. (å…³è”è¡¨)
```

## ğŸ¯ å…³é”®è®¾è®¡ç‰¹ç‚¹

### 1. **äº‹åŠ¡ä¸€è‡´æ€§**

- å¦‚æœä¸šåŠ¡å®ä½“åˆ›å»ºå¤±è´¥ï¼Œä¼šè‡ªåŠ¨åˆ é™¤å·²åˆ›å»ºçš„ ApplicationUser
- ç¡®ä¿æ•°æ®çš„ä¸€è‡´æ€§

### 2. **å‚æ•°éªŒè¯**

- å¤šå±‚éªŒè¯ï¼šæ¨¡å‹éªŒè¯ â†’ æœåŠ¡å±‚éªŒè¯ â†’ ä»“å‚¨å±‚éªŒè¯
- å‹å¥½çš„é”™è¯¯ä¿¡æ¯è¿”å›

### 3. **æ‰©å±•æ€§**

- é¢„ç•™äº†å…¶ä»– UserType çš„å®ç°æ¥å£
- å¯ä»¥è½»æ¾æ‰©å±•å•†å®¶ã€éª‘æ‰‹ã€ç®¡ç†å‘˜çš„æ³¨å†Œé€»è¾‘

### 4. **é”™è¯¯å¤„ç†**

- ç»Ÿä¸€çš„å¼‚å¸¸å¤„ç†æœºåˆ¶
- è¯¦ç»†çš„æ—¥å¿—è®°å½•
- æ ‡å‡†çš„ API å“åº”æ ¼å¼

## ğŸš€ API ä½¿ç”¨ç¤ºä¾‹

### æ³¨å†Œæ™®é€šç”¨æˆ·

```http
POST /api/auth/register
Content-Type: application/json

{
  "userName": "testuser001",
  "passWord": "Test123456",
  "userType": 1,
  "email": "test@example.com",
  "nickname": "æµ‹è¯•ç”¨æˆ·"
}
```

### æˆåŠŸå“åº”

```json
{
  "code": 0,
  "message": "æ³¨å†ŒæˆåŠŸ",
  "data": {
    "applicationUserId": "guid-string",
    "businessEntityId": "user-id-string",
    "userType": 1
  },
  "timestamp": 1678886400000
}
```

## ğŸ“ˆ åç»­æ‰©å±•æ–¹å‘

1. **å®ç°å…¶ä»–ç”¨æˆ·ç±»å‹çš„æ³¨å†Œ**ï¼š

   - å•†å®¶æ³¨å†Œï¼ˆUserType=2ï¼‰
   - éª‘æ‰‹æ³¨å†Œï¼ˆUserType=3ï¼‰
   - ç®¡ç†å‘˜æ³¨å†Œï¼ˆUserType=4ï¼‰

2. **å¢å¼ºåŠŸèƒ½**ï¼š

   - é‚®ç®±éªŒè¯
   - æ‰‹æœºå·éªŒè¯
   - éªŒè¯ç æœºåˆ¶
   - å¯†ç å¼ºåº¦éªŒè¯

3. **æ€§èƒ½ä¼˜åŒ–**ï¼š
   - æ·»åŠ ç¼“å­˜æœºåˆ¶
   - æ•°æ®åº“è¿æ¥æ± ä¼˜åŒ–
   - å¼‚æ­¥å¤„ç†ä¼˜åŒ–

